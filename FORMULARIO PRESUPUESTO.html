<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transferencia de Veh√≠culo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700;800;900&display=swap" rel="stylesheet">
  </head>

  <body>
<!-- Fondo + centrado -->
<div style="min-height:100vh;background:#f3f5fb;padding:24px 12px;box-sizing:border-box;">
  <!-- Tarjeta -->
  <div style="max-width:1160px;margin:0 auto;background:#fff;border-radius:22px;box-shadow:0 18px 45px rgba(0,0,0,.12);font-family:Arial;">


    <!-- Cabecera tarjeta -->
    <div style="background:#061a4a;color:#fff;padding:18px 18px;display:flex;align-items:center;gap:12px;">
      
<div style="flex:1;text-align:center;">
  <div style="
    font-family:'Open Sans', Arial, sans-serif;
    font-weight:900;
    font-size:30px;
    line-height:1.1;
    text-transform:uppercase;
    letter-spacing:0.6px;
    color:#ffffff;
    font-style:italic;

    text-shadow:
      -2px -2px 0 #061a4a,
       2px -2px 0 #061a4a,
      -2px  2px 0 #061a4a,
       2px  2px 0 #061a4a,
       0px  4px 0 rgba(0,0,0,0.25);
  ">
    TRANSFERENCIA DE VEH√çCULO
  </div>
</div>
    </div>

    <!-- Cuerpo tarjeta -->
    <div style="padding:18px 18px 20px 18px;">
         <!-- ‚úÖ GRID PADRE (2 columnas) -->
  <div style="display:grid;grid-template-columns:1fr 340px;gap:18px;align-items:start;">


<!-- ===================== -->
    <!-- COLUMNA IZQUIERDA -->
    <!-- ===================== -->
    <div style="display:grid;gap:14px;">
      <!-- SUBTARJETA 1: DATOS DE CONTACTO -->
      <div style="border:1px solid #e8ecf6;border-radius:18px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:14px;">
        <div style="background:#061a4a;color:#fff;padding:12px 14px;font-weight:800;display:flex;align-items:center;gap:10px;">
  
  <!-- Icono mu√±eco -->
  <div style="width:28px;height:28px;border-radius:999px;background:#ff5b2e;display:flex;align-items:center;justify-content:center;flex:0 0 auto;">
    <svg width="25" height="20" viewBox="0 0 24 24" fill="none">
      <path d="M12 12c2.76 0 5-2.24 5-5S14.76 2 12 2 7 4.24 7 7s2.24 5 5 5Z" stroke="#fff" stroke-width="2"/>
      <path d="M4 22c0-4.42 3.58-8 8-8s8 3.58 8 8" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>

  <span>Datos de contacto</span>
</div>

<div style="padding:14px;">
        
          <!-- Email de contacto -->
          <div>
            <label style="font-weight:600">Email de contacto</label><br>
            <input
              id="emailContacto"
              type="email"
              required
              placeholder="tuemail@gmail.com"
              style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
            />
          </div>
        </div>
      </div>

      <!-- SUBTARJETA 2: DATOS DEL VEH√çCULO -->
      <div style="border:1px solid #e8ecf6;border-radius:18px;box-shadow:0 6px 18px rgba(0,0,0,.06);">

        <div style="background:#061a4a;color:#fff;padding:12px 14px;font-weight:800;display:flex;align-items:center;gap:10px;">
  
  <!-- ICONO DE COCHE BLANCO -->
<span style="
  width:28px;
  height:28px;
  border-radius:999px;
  background:#ff5b2e;
  display:flex;
  align-items:center;
  justify-content:center;
  flex:0 0 auto;
">
  <svg xmlns="http://www.w3.org/2000/svg"
       viewBox="0 0 420.849 420.849"
       width="25" height="25"
       style="display:block;">
    <g fill="#fff">
      <path d="m81.123,216.924c-17.161,0-31.125,13.959-31.125,31.12 0,17.166 13.959,31.131 31.125,31.131 17.155,0 31.12-13.959 31.12-31.131-1.42109e-14-17.156-13.965-31.12-31.12-31.12zm0,44.956c-7.631,0-13.831-6.205-13.831-13.837 0-7.62 6.199-13.825 13.831-13.825 7.626,0 13.825,6.205 13.825,13.825-1.42109e-14,7.626-6.199,13.837-13.825,13.837z"/>
      <path d="m339.65,222.541c-15.612,0-28.308,12.702-28.308,28.308s12.702,28.32 28.308,28.32c15.606,0 28.308-12.713 28.308-28.32s-12.696-28.308-28.308-28.308zm0,39.339c-6.083,0-11.019-4.948-11.019-11.031 0-6.071 4.936-11.019 11.019-11.019 6.071,0 11.019,4.948 11.019,11.019 0,6.083-4.948,11.031-11.019,11.031z"/>
      <rect width="177.544" x="120.497" y="257.375" height="17.295"/>
      <polygon points="415.202,206.405 407.012,198.226 391.371,190.746 285.421,180.705 231.121,141.674 185.461,141.674 127.465,151.541 59.835,182.794 43.699,177.637 0,177.637 0,191.712 13.441,211.877 0,220.981 0,251.67 12.079,263.743 24.303,251.524 17.283,244.504 17.283,230.161 37.354,216.574 22.918,194.926 41.004,194.926 60.976,201.317 132.634,168.201 186.922,158.969 225.55,158.969 279.134,197.475 386.685,207.662 396.883,212.546 399.945,215.596 403.275,226.406 402.012,237.728 391.953,252.84 406.331,262.439 418.736,243.823 420.849,224.736"/>
    </g>
  </svg>
</span>


  <span>Datos del veh√≠culo</span>
  
</div>


<div style="padding:14px;">

  


      <!-- FORM (todos tus campos) -->
      <div style="display:grid;grid-template-columns:1fr;gap:12px">

        <!-- Matr√≠cula -->
        <div>
          <label style="font-weight:600">Matr√≠cula del veh√≠culo</label><br>
          <input
            id="matriculaVehiculo"
            type="text"
            required
            placeholder="Ej: 1234 ABC"
            style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box;text-transform:uppercase;"
          />
        </div>

        <!-- Marca -->
        <div>
          <label style="font-weight:600">Marca</label><br>
          <select id="marca" required style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0">
            <option value="">Selecciona marca‚Ä¶</option>
          </select>
        </div>

        <!-- Fecha primera matriculaci√≥n (custom picker) -->
        <div>
          <label style="font-weight:600">Fecha de primera matriculaci√≥n</label><br>
          <div id="fechaWrap" style="position:relative;width:100%;">
            <input
              id="fechaInput"
              type="text"
              readonly
              placeholder="Selecciona fecha‚Ä¶"
              style="width:100%;padding:12px 40px 12px 12px;border-radius:10px;border:1px solid #d0d0d0;outline:none;box-sizing:border-box;background:#fff;cursor:pointer;"
            />
            <div
              id="fechaIcon"
              style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:22px;height:22px;opacity:.7;pointer-events:none;"
            >
              <!-- icono calendario (SVG inline) -->
              <svg viewBox="0 0 24 24" width="22" height="22" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 2v3M17 2v3" stroke="#061a4a" stroke-width="2" stroke-linecap="round"/>
                <path d="M3.5 9h17" stroke="#061a4a" stroke-width="2" stroke-linecap="round"/>
                <path d="M6 5h12a3 3 0 0 1 3 3v11a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V8a3 3 0 0 1 3-3Z" stroke="#061a4a" stroke-width="2"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Combustible -->
        <div>
          <label style="font-weight:600">Combustible</label><br>
          <select id="combustible" disabled style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0">
            <option value="">Selecciona combustible‚Ä¶</option>
          </select>
        </div>

        <!-- Modelo (CUSTOM con preview hover) -->
        <div style="position:relative">
          <label style="font-weight:600">Modelo</label><br>

          <input
            id="modeloInput"
            type="text"
            disabled
            placeholder="Selecciona modelo‚Ä¶"
            style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
          />

          <div
            id="modeloList"
            style="display:none;position:absolute;left:0;right:0;top:calc(100% + 6px);background:#fff;border:1px solid #e6e6e6;border-radius:12px;box-shadow:0 10px 26px rgba(0,0,0,.12);max-height:280px;overflow:auto;z-index:999999"
          ></div>

          <div
            id="modeloPreview"
            style="display:none;position:absolute;right:0;top:calc(100% + 6px);transform:translateX(105%);width:260px;background:#061a4a;color:#fff;border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.18);padding:12px;z-index:1000000"
          ></div>
        </div>
<!-- ‚úÖ Checkbox: modelo no aparece -->
<div style="margin-top:10px;">
  <label style="display:flex;align-items:center;gap:10px;font-weight:700;color:#061a4a;">
    <input type="checkbox" id="modeloNoLista" style="transform:scale(1.15)" />
    Mi veh√≠culo no aparece en la lista
  </label>

  <!-- Caja informativa -->
  <div
    id="modeloNoListaInfo"
    style="
      display:none;
      margin-top:10px;
      border:1px solid #061a4a;
      border-radius:10px;
      padding:12px;
      background:#fff;
      color:#061a4a;
      font-size:13px;
      line-height:1.45;
    "
  >
    <b>Dado que tu veh√≠culo no aparece recogido en las tablas de valoraci√≥n de la DGT introduce los datos manualmente</b>
  </div>

  <!-- Campos manuales (solo si checkbox ON) -->
  <div id="wrapModeloManual" style="display:none;margin-top:12px;">
    <div style="display:grid;gap:12px;">

      <div>
        <label style="font-weight:600">Modelo - (D.3) Permiso</label><br>
        <input
          id="modeloManual"
          type="text"
          placeholder="Ej: GOLF"
          style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
        />
      </div>

      <div>
        <label style="font-weight:600">Cilindrada - P.1</label><br>
        <input
          id="ccManual"
          type="text"
          inputmode="numeric"
          placeholder="Ej: 1998"
          style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
        />
      </div>

      <div>
        <label style="font-weight:600">Potencia Fiscal - P.2.1</label><br>
        <input
          id="cvfManual"
          type="text"
          inputmode="decimal"
          placeholder="Ej: 15,23"
          style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
        />
      </div>

      <div>
        <label style="font-weight:600">CVF/KW - P.2</label><br>
        <input
          id="kwManual"
          type="text"
          inputmode="numeric"
          placeholder="Ej: 77"
          style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
        />
      </div>

    </div>
  </div>
</div>

       <!-- Precio -->
<div id="wrapPrecioContrato" style="margin-top:12px;">
  <label style="font-weight:600">Precio</label><br>
  <input
    id="precioContrato"
    type="text"
    inputmode="decimal"
    placeholder="Precio por contrato: indicar"
    style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
  />

  <!-- Chuletilla informativa -->
  <div
    style="
      margin-top:8px;
      padding:10px 12px;
      border-radius:10px;
      background:#f3f5fb;
      border:1px solid #e0e6ff;
      color:#061a4a;
      font-size:13px;
      line-height:1.45;
    "
  >
    <b>Nota:</b> La <b>base imponible</b> ser√° el <b>valor por tablas</b> una vez aplicado el <b>factor de correcci√≥n</b> (a√±os de uso).
  Si el <b>precio indicado en el contrato</b> es superior a esa base, se tomar√° como <b>base imponible</b> el precio del contrato.
  </div>
</div>


      </div>

      <!-- FICHA T√âCNICA (se queda en la izquierda, debajo) -->
      <div id="fichaWrap" style="display:none;margin-top:16px;border-radius:18px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.10)">
        <div style="background:#ff5b2e;color:#fff;padding:14px 16px;font-weight:700">
          Datos t√©cnicos de tu veh√≠culo
        </div>

        <div style="background:#061a4a;color:#fff;padding:16px">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
            <div>
              <div style="opacity:.85;font-size:13px">Marca</div>
              <div id="ft_marca" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">Modelo</div>
              <div id="ft_modelo" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">Combustible</div>
              <div id="ft_comb" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">Valoraci√≥n (seg√∫n a√±os de uso)</div>
              <div id="ft_valor_ajustado" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">Valor base 2026 (‚Ç¨)</div>
              <div id="ft_valor_base" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">Fecha primera matriculaci√≥n</div>
              <div id="ft_fecha" style="font-size:16px;font-weight:700"></div>
            </div>

            <div>
              <div style="opacity:.85;font-size:13px">Potencia (kW)</div>
              <div id="ft_kw" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">Potencia (CV)</div>
              <div id="ft_cv" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">Potencia fiscal (CVF)</div>
              <div id="ft_cvf" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">Cilindrada (cc)</div>
              <div id="ft_cc" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">Cilindros</div>
              <div id="ft_cil" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">Periodo comercial</div>
              <div id="ft_periodo" style="font-size:16px;font-weight:700"></div>

              <div style="height:10px"></div>

              <div style="opacity:.85;font-size:13px">A√±os de uso / % aplicado</div>
              <div id="ft_uso_pct" style="font-size:16px;font-weight:700"></div>
            </div>
          </div>
        </div>
      </div>

    </div>

    

  </div>

</div>
<!-- ===================== -->
    <!-- COLUMNA DERECHA -->
    <!-- ===================== -->
    <div style="position:sticky; top:18px; align-self:start;">

      <!-- PRESUPUESTO ITP (AQU√ç A LA DERECHA) -->
      <div
        id="itpPresupuestoWrap"
        style="border:1px solid #e8ecf6;border-radius:18px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.10);background:#fff;"
      >
        <div style="background:#061a4a;color:#fff;padding:12px 14px;font-weight:900;display:flex;align-items:center;gap:10px;">

  <!-- ICONO DINERO -->
  <span style="
    width:28px;
    height:28px;
    border-radius:999px;
    background:#ff5b2e;
    display:flex;
    align-items:center;
    justify-content:center;
    flex:0 0 auto;
  ">
    <svg viewBox="0 0 48 67"
         xmlns="http://www.w3.org/2000/svg"
         width="25" height="23"
         style="display:block;">
      <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g transform="translate(1, 3)" stroke="#fff" stroke-width="2">
          <path d="M14.4,2.6 C14.4,2.6 24.5,-4.3 26.1,6"></path>
          <path d="M25.4,3.2 C25.4,3.2 27.2,-0.4 36,0.1 C36,2.9 33.4,10 29.5,11.3 C39,16.9 46,33.5 46,43.5 C46,55.6 36.7,62.1 24,62.1 C11.3,62.1 0,55.6 0,43.5 C0,33.6 6.9,16.9 16.5,11.3 C12.6,10 10,2.9 10,0.1 C10,0.1 14.4,4 20,4"></path>
          <path d="M16.4,11 L31.1,11"></path>
          <path d="M31.1,12.3 C31.1,12.3 42.3,12 42.3,18.3"></path>
          <path d="M31.3,10.4 C31.3,10.4 40,10.9 45.2,7.6"></path>
          <path d="M29.9,48.5 C28.5,50.1 26.7,51 24.7,51 C20.4,51 17,46.7 17,41.3 C17,36 20.5,32 24.7,32 C26.7,32 28.4,32.6 29.8,34.1"></path>
          <path d="M14.1,38.9 L26,38.9"></path>
          <path d="M13.1,43 L25,43"></path>
        </g>
      </g>
    </svg>
  </span>

  <span>Presupuesto</span>
</div>



        <div style="padding:14px;">
          <div style="font-weight:900;color:#061a4a;margin-bottom:10px;">C√ÅLCULO ITP</div>

          <div style="display:grid;gap:8px;font-size:14px;color:#061a4a;">
            <div style="display:flex;justify-content:space-between;gap:10px;">
              <div>Valoraci√≥n inicial</div>
              <div id="itp_valoracion_inicial" style="font-weight:800;">‚Äî</div>
            </div>

            <div style="display:flex;justify-content:space-between;gap:10px;">
              <div>Factor de correcci√≥n</div>
              <div id="itp_factor" style="font-weight:800;">‚Äî</div>
            </div>

            <div style="display:flex;justify-content:space-between;gap:10px;">
              <div>Base imponible</div>
              <div id="itp_base" style="font-weight:800;">‚Äî</div>
            </div>

            <div style="display:flex;justify-content:space-between;gap:10px;">
              <div>Impuesto</div>
              <div id="itp_tipo" style="font-weight:800;">‚Äî</div>
            </div>

            <div style="display:flex;justify-content:space-between;gap:10px;">
              <div>ITP</div>
              <div id="itp_cuota" style="font-weight:800;">‚Äî</div>
            </div>
 <div style="display:flex;justify-content:space-between;gap:10px;">
        <div>Tasa Tr√°fico</div>
        <div style="font-weight:800;">55,70‚Ç¨</div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:10px;">
        <div>Colegio Gestores</div>
        <div style="font-weight:800;">5,75‚Ç¨</div>
      </div>

          <div style="display:flex;justify-content:space-between;gap:10px;">
        <div>Gesti√≥n Hervas</div>
        <div id="itp_gestion_hervas" style="font-weight:800;">‚Äî</div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:10px;">
        <div>IVA 21% (Gesti√≥n Hervas)</div>
        <div id="itp_iva_gestion_hervas" style="font-weight:800;">‚Äî</div>
      </div>

      <div style="border-top:1px solid #e8ecf6;margin:8px 0;"></div>

            <div style="display:flex;justify-content:space-between;gap:10px;font-weight:900;">
              <div>TOTAL</div>
              <div id="itp_total" style="font-weight:900;">‚Äî</div>
            </div>
          </div>
        </div>
      </div>
<!-- üîΩ AQU√ç VA EL NUEVO APARTADO (INTELIGENTE) -->
<div style="margin-top:14px;border:1px solid #e8ecf6;border-radius:18px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.10);background:#fff;">
  <div style="padding:14px 14px 12px 14px;">
    <div style="font-weight:900;color:#061a4a;font-size:16px;line-height:1.2;">
      Datos necesarios para calcular el presupuesto:
    </div>

    <div style="margin-top:10px;display:grid;gap:8px;font-size:14px;color:#061a4a;">

      <div style="display:flex;align-items:center;gap:10px;">
        <span id="need_marca_icon" style="width:18px;display:inline-flex;justify-content:center;font-weight:900;">‚úó</span>
        <span>Marca</span>
      </div>

      <div style="display:flex;align-items:center;gap:10px;">
        <span id="need_fecha_icon" style="width:18px;display:inline-flex;justify-content:center;font-weight:900;">‚úó</span>
        <span>Fecha de matriculaci√≥n</span>
      </div>

      <div style="display:flex;align-items:center;gap:10px;">
        <span id="need_comb_icon" style="width:18px;display:inline-flex;justify-content:center;font-weight:900;">‚úó</span>
        <span>Combustible</span>
      </div>

      <div style="display:flex;align-items:center;gap:10px;">
        <span id="need_modelo_icon" style="width:18px;display:inline-flex;justify-content:center;font-weight:900;">‚úó</span>
        <span>Modelo</span>
      </div>

      <div style="display:flex;align-items:center;gap:10px;">
        <span id="need_prov_icon" style="width:18px;display:inline-flex;justify-content:center;font-weight:900;">‚úó</span>
        <span>Provincia del comprador</span>
      </div>

    </div>
  </div>
</div>
<!-- üîº FIN NUEVO APARTADO -->
    </div>
      
      <!-- SUBTARJETA 2: DATOS DEL TR√ÅMITE -->
<div style="border:1px solid #e8ecf6;border-radius:18px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:14px;">
  <div style="background:#061a4a;color:#fff;padding:12px 14px;font-weight:800;display:flex;align-items:center;gap:10px;">

  <!-- ICONO INTERCAMBIO (mismo tama√±o que los otros: 28x28) -->
  <span style="
    width:28px;
    height:28px;
    border-radius:999px;
    background:#ff5b2e;
    display:flex;
    align-items:center;
    justify-content:center;
    flex:0 0 auto;
  ">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25" fill="none" style="display:block;">
      <path d="M7 7h11" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M16 5l2 2-2 2" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M17 17H6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M8 15l-2 2 2 2" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </span>

  <span>Datos del tr√°mite</span>
</div>


  <div style="padding:14px;">
    <div>
      <label style="font-weight:600">Tipo de gesti√≥n</label><br>
      <select
  id="tipoGestion"
  disabled
  style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box;background:#f5f5f5;cursor:not-allowed"
>
  <option value="TRANSFERENCIA TURISMO TR1">TRANSFERENCIA TURISMO TR1</option>
</select>

    </div>
    <!-- Casos concretos -->
<div style="margin-top:12px">
  <label style="font-weight:600">Casos concretos</label><br>
  <select
    id="casosConcretos"
    disabled
    style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
  >
    
    <option value="NINGUNO">NINGUNO</option>
    <option value="DIVORCIO">DIVORCIO</option>
    <option value="MENOR (COMPRADOR)">MENOR (COMPRADOR)</option>
    <option value="MENOR (VENDEDOR)">MENOR (VENDEDOR)</option>
    <option value="INCAPACIDAD (COMPRADOR)">INCAPACIDAD (COMPRADOR)</option>
    <option value="INCAPACIDAD (VENDEDOR)">INCAPACIDAD (VENDEDOR)</option>
  </select>
</div>
<!-- Sexo -->
<div style="margin-top:12px">
  <label style="font-weight:600">Sexo Comprador</label><br>
  <select
    id="sexo"
    style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
  >
    <option value="">SELECCIONA‚Ä¶</option>
    <option value="HOMBRE">HOMBRE</option>
    <option value="MUJER">MUJER</option>
    <option value="SOCIEDAD">SOCIEDAD</option>
  </select>
</div>
<!-- Sexo vendedor -->
<div style="margin-top:12px">
  <label style="font-weight:600">Sexo vendedor</label><br>
  <select
    id="sexoVendedor"
    style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
  >
    <option value="">SELECCIONA‚Ä¶</option>
    <option value="HOMBRE">HOMBRE</option>
    <option value="MUJER">MUJER</option>
    <option value="SOCIEDAD">SOCIEDAD</option>
  </select>
</div>
<!-- ¬øEs aut√≥nomo? Vendedor -->
<div id="wrapAutonomoVendedor" style="margin-top:12px">
  <label style="font-weight:600">
    <input
      type="checkbox"
      id="autonomoVendedor"
      style="margin-right:8px;transform:scale(1.2)"
    />
    ¬øEs aut√≥nomo? Vendedor
  </label>
</div>

<!-- Provincia comprador -->
<div id="wrapProvinciaComprador" style="margin-top:12px">
  <label style="font-weight:600">Provincia comprador</label><br>
  <select
    id="provinciaComprador"
    style="width:100%;padding:12px;border-radius:10px;border:1px solid #d0d0d0;box-sizing:border-box"
  >
    <option value="">SELECCIONA PROVINCIA‚Ä¶</option>

    <option value="A CORU√ëA">A CORU√ëA</option>
    <option value="√ÅLAVA / ARABA">√ÅLAVA / ARABA</option>
    <option value="ALBACETE">ALBACETE</option>
    <option value="ALICANTE / ALACANT">ALICANTE / ALACANT</option>
    <option value="ALMER√çA">ALMER√çA</option>
    <option value="ASTURIAS">ASTURIAS</option>
    <option value="√ÅVILA">√ÅVILA</option>
    <option value="BADAJOZ">BADAJOZ</option>
    <option value="BARCELONA">BARCELONA</option>
    <option value="BURGOS">BURGOS</option>
    <option value="C√ÅCERES">C√ÅCERES</option>
    <option value="C√ÅDIZ">C√ÅDIZ</option>
    <option value="CANTABRIA">CANTABRIA</option>
    <option value="CASTELL√ìN / CASTELL√ì">CASTELL√ìN / CASTELL√ì</option>
    <option value="CEUTA">CEUTA</option>
    <option value="CIUDAD REAL">CIUDAD REAL</option>
    <option value="C√ìRDOBA">C√ìRDOBA</option>
    <option value="CUENCA">CUENCA</option>
    <option value="GIPUZKOA">GIPUZKOA</option>
    <option value="GIRONA">GIRONA</option>
    <option value="GRANADA">GRANADA</option>
    <option value="GUADALAJARA">GUADALAJARA</option>
    <option value="HUELVA">HUELVA</option>
    <option value="HUESCA">HUESCA</option>
    <option value="ISLAS BALEARES / ILLES BALARS">ISLAS BALEARES / ILLES BALARS</option>
    <option value="JA√âN">JA√âN</option>
    <option value="LA RIOJA">LA RIOJA</option>
    <option value="LAS PALMAS">LAS PALMAS</option>
    <option value="LE√ìN">LE√ìN</option>
    <option value="LLEIDA">LLEIDA</option>
    <option value="LUGO">LUGO</option>
    <option value="MADRID">MADRID</option>
    <option value="M√ÅLAGA">M√ÅLAGA</option>
    <option value="MELILLA">MELILLA</option>
    <option value="MURCIA">MURCIA</option>
    <option value="NAVARRA">NAVARRA</option>
    <option value="OURENSE">OURENSE</option>
    <option value="PALENCIA">PALENCIA</option>
    <option value="PONTEVEDRA">PONTEVEDRA</option>
    <option value="SALAMANCA">SALAMANCA</option>
    <option value="SANTA CRUZ DE TENERIFE">SANTA CRUZ DE TENERIFE</option>
    <option value="SEGOVIA">SEGOVIA</option>
    <option value="SEVILLA">SEVILLA</option>
    <option value="SORIA">SORIA</option>
    <option value="TARRAGONA">TARRAGONA</option>
    <option value="TERUEL">TERUEL</option>
    <option value="TOLEDO">TOLEDO</option>
    <option value="VALENCIA / VAL√àNCIA">VALENCIA / VAL√àNCIA</option>
    <option value="VALLADOLID">VALLADOLID</option>
    <option value="VIZCAYA / BIZKAIA">VIZCAYA / BIZKAIA</option>
    <option value="ZAMORA">ZAMORA</option>
    <option value="ZARAGOZA">ZARAGOZA</option>
  </select>
</div>
<!-- Provincia vendedor -->
<!-- Provincia explotaci√≥n comprador -->

<!-- Provincia explotaci√≥n vendedor -->

  </div>
    <!-- BOT√ìN -->
          <div id="btnWrap" style="margin-top:16px">
            <button
              id="btnEnviar"
              type="button"
              style="
                position:relative;
                width:100%;
                padding:14px 16px;
                border-radius:12px;
                border:0;
                font-weight:700;
                color:#fff;
                cursor:pointer;
                background:#ff5b2e;
                overflow:hidden;
              "
            >
              <div
                id="btnProgress"
                style="
                  position:absolute;
                  top:0;
                  left:0;
                  height:100%;
                  width:0%;
                  background:rgba(255,255,255,0.35);
                  transition:width 0.25s linear;
                  z-index:1;
                "
              ></div>

              <span id="btnText" style="position:relative;z-index:2">
                Enviar selecci√≥n
              </span>
            </button>

            <div id="msg" style="margin-top:10px;font-size:13px"></div>
          </div>
</div>




      <!-- DATE PICKER MODAL (todo inline) -->
      <div
        id="fechaOverlay"
        style="
          display:none;
          position:fixed;
          inset:0;
          background:rgba(0,0,0,0.35);
          z-index:999999;
        "
      ></div>

      <div
        id="fechaModal"
        style="
          display:none;
          position:fixed;
          left:50%;
          top:50%;
          transform:translate(-50%,-50%);
          width:min(420px, calc(100vw - 24px));
          background:#fff;
          border-radius:14px;
          box-shadow:0 18px 50px rgba(0,0,0,.25);
          z-index:1000000;
          overflow:hidden;
          font-family:Arial;
        "
      >
        <!-- header -->
        <div
          style="
            background:#061a4a;
            color:#fff;
            padding:12px 14px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
          "
        >
          <div style="font-weight:700" id="fechaModalTitle">Selecciona a√±o</div>
          <button
            id="fechaClose"
            type="button"
            style="
              border:0;
              background:rgba(255,255,255,0.15);
              color:#fff;
              width:34px;
              height:30px;
              border-radius:8px;
              cursor:pointer;
              font-weight:700;
            "
          >‚úï</button>
        </div>

        <!-- body -->
        <div style="padding:12px 12px 10px 12px">
          <!-- top controls -->
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
            <button
              id="fechaBack"
              type="button"
              style="
                display:none;
                border:1px solid #e6e6e6;
                background:#fff;
                padding:8px 10px;
                border-radius:10px;
                cursor:pointer;
                font-weight:700;
                color:#061a4a;
              "
            >‚Üê</button>

            <div id="fechaRangeLabel" style="font-weight:700;color:#061a4a;flex:1;text-align:center"></div>

            <div style="display:flex;gap:8px">
              <button
                id="fechaPrev"
                type="button"
                style="
                  border:1px solid #e6e6e6;
                  background:#fff;
                  width:40px;
                  height:36px;
                  border-radius:10px;
                  cursor:pointer;
                  font-weight:900;
                  color:#061a4a;
                "
              >‚Äπ</button>
              <button
                id="fechaNext"
                type="button"
                style="
                  border:1px solid #e6e6e6;
                  background:#fff;
                  width:40px;
                  height:36px;
                  border-radius:10px;
                  cursor:pointer;
                  font-weight:900;
                  color:#061a4a;
                "
              >‚Ä∫</button>
            </div>
          </div>

          <!-- grid -->
          <div id="fechaGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px"></div>

          <!-- calendar -->
          <div id="fechaCalendar" style="display:none;margin-top:10px">
            <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:6px 0 8px 0">
              <div style="text-align:center;font-size:12px;font-weight:700;color:#667">LU</div>
              <div style="text-align:center;font-size:12px;font-weight:700;color:#667">MA</div>
              <div style="text-align:center;font-size:12px;font-weight:700;color:#667">MI</div>
              <div style="text-align:center;font-size:12px;font-weight:700;color:#667">JU</div>
              <div style="text-align:center;font-size:12px;font-weight:700;color:#667">VI</div>
              <div style="text-align:center;font-size:12px;font-weight:700;color:#667">SA</div>
              <div style="text-align:center;font-size:12px;font-weight:700;color:#667">DO</div>
            </div>
            <div id="fechaDays" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>

  // ‚úÖ PON ESTO LO PRIMERO DE TODO
  const restBase = "https://hervas.bitrix24.eu/rest/806/8quen10as3v74yz5/";
  // ‚úÖ FORZAR ETAPA DEL LEAD (por si Bitrix ignora STATUS_ID en el add)
async function forceLeadStage(leadId, statusId) {
  const url = restBase + "crm.lead.update.json";
  const p = new URLSearchParams();
  p.set("id", leadId);
  p.set("fields[STATUS_ID]", statusId);

  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: p.toString()
  });

  const j = await r.json();
  console.log("forceLeadStage:", j);
  if (j.error) throw new Error(j.error_description || j.error);
  return true;
}
    // Normaliza texto: trim + MAYUS + sin acentos
// Normaliza texto: trim + MAYUS + sin acentos, PERO conserva la √ë
function normTxt(s){
  return (s ?? "")
    .toString()
    .trim()
    .toUpperCase()
    // proteger √ë antes de normalizar
    .replace(/√ë/g, "__ENYE__")
    .normalize("NFD")
    .replace(/[ÃÄ-ÕØ]/g, "")
    // restaurar √ë
    .replace(/__ENYE__/g, "√ë");
}
const chkModeloNoLista = document.getElementById("modeloNoLista");
const modeloNoListaInfo = document.getElementById("modeloNoListaInfo");
const wrapModeloManual = document.getElementById("wrapModeloManual");

const modeloManualEl = document.getElementById("modeloManual");
const ccManualEl     = document.getElementById("ccManual");
const cvfManualEl    = document.getElementById("cvfManual");
const kwManualEl     = document.getElementById("kwManual");

function modoManualActivo(){
  return !!document.getElementById("modeloNoLista")?.checked;
}
function manualOk(){
  if (!modoManualActivo()) return false;

  const m  = (modeloManualEl?.value || "").trim();
  const cc = (ccManualEl?.value || "").trim();
  const cvf= (cvfManualEl?.value || "").trim();
  const kw = (kwManualEl?.value || "").trim();

  return !!m && !!cc && !!cvf && !!kw;
}

function modeloOkGlobal(){
  return (!!(modeloSeleccionado && modeloSeleccionado.nombre)) || manualOk();
}


function toggleModeloManual(){
  const on = modoManualActivo();

  // mostrar/ocultar
  if (modeloNoListaInfo) modeloNoListaInfo.style.display = on ? "block" : "none";
  if (wrapModeloManual)  wrapModeloManual.style.display  = on ? "block" : "none";
  
  // ‚úÖ activar/desactivar inputs manuales
if (modeloManualEl) modeloManualEl.disabled = !on;
if (ccManualEl)     ccManualEl.disabled     = !on;
if (cvfManualEl)    cvfManualEl.disabled    = !on;
if (kwManualEl)     kwManualEl.disabled     = !on;
if (!on) {
  if (modeloManualEl) modeloManualEl.value = "";
  if (ccManualEl)     ccManualEl.value     = "";
  if (cvfManualEl)    cvfManualEl.value    = "";
  if (kwManualEl)     kwManualEl.value     = "";
}

  // si manual ON => bloquear selector de modelo y limpiar selecci√≥n
  if (on) {
    modeloSeleccionado = null;         // clave
    if (modeloInput) {
      modeloInput.value = "";
      modeloInput.disabled = true;
    }
    if (modeloList) modeloList.style.display = "none";
    if (modeloPrev) modeloPrev.style.display = "none";
    ocultarFicha(); // quita ficha t√©cnica
  } else {
    // si manual OFF => permitir volver a seleccionar (si hay marca+comb)
    if (marcaObj && anioMat && combSel?.value) {
      cargarModelosFiltrados();
    }
  }

  actualizarPresupuestoITP();
  actualizarNecesariosPresupuesto();
  refrescarBotonEnviar();
}

chkModeloNoLista?.addEventListener("change", toggleModeloManual);

  const marcaSel  = document.getElementById("marca");
  const combSel   = document.getElementById("combustible");
  const emailContacto = document.getElementById("emailContacto");
  const matriculaVehiculo = document.getElementById("matriculaVehiculo");
// ====== MAPA tipo de gesti√≥n (texto) -> ID Bitrix ======
const MAP_TIPO_GESTION_BITRIX = {
  "NOTIFICACION NOT": "1714",

  "HERENCIA VEHICULO": "31856",
  "HERENCIA AGRICOLA": "16092",

  "TRANSFERENCIA TURISMO TR1": "1712",
  "TRANSFERENCIA FURGONETA TR2": "16786",
  "TRANSFERENCIA CAMION TR3": "16788",
  "TRANSFERENCIA MOTO TR4": "16790",
  "TRANSFERENCIA CICLOMOTOR TR5": "16792",
  "TRANSFERENCIA AGRICOLA TR6": "15438",
  "TRANSFERENCIA OTROS TR7": "16794"
};
// ====== MAPA casos concretos (texto) -> ID Bitrix ======
const MAP_CASOS_CONCRETOS_BITRIX = {
  "NINGUNO": "34274",
  "DIVORCIO": "34276",
  "MENOR (COMPRADOR)": "34278",
  "MENOR (VENDEDOR)": "34280",
  "INCAPACIDAD (COMPRADOR)": "34394",
  "INCAPACIDAD (VENDEDOR)": "34402"
};



// ====== MAPA sexo (texto) -> ID Bitrix ======
const MAP_SEXO_BITRIX = {
  "HOMBRE": "14272",
  "MUJER": "14274",
  "SOCIEDAD": "14276"
};

// ====== MAPA sexo vendedor (texto) -> ID Bitrix ======
const MAP_SEXO_VENDEDOR_BITRIX = {
  "HOMBRE": "14278",
  "MUJER": "14280",
  "SOCIEDAD": "14282"
};

// ====== MAPA liquidaci√≥n impuesto transmisiones (texto) -> ID Bitrix ======
const MAP_LIQ_IMP_TRANS_BITRIX = {
  "CONTRATO": "41064",
  "TABLAS": "41066"
};


// ====== MAPA provincia comprador (texto) -> ID Bitrix (SIN ACENTOS) ======
const MAP_PROVINCIA_COMPRADOR_BITRIX = {
  "A CORU√ëA": "13296",
  "ALAVA / ARABA": "13298",
  "ALBACETE": "13300",
  "ALICANTE / ALACANT": "13302",
  "ALMERIA": "13304",
  "ASTURIAS": "13306",
  "AVILA": "13308",
  "BADAJOZ": "13310",
  "BARCELONA": "13314",
  "BURGOS": "13316",
  "CACERES": "13318",
  "CADIZ": "13320",
  "CANTABRIA": "13322",
  "CASTELLON / CASTELLO": "13324",
  "CEUTA": "13326",
  "CIUDAD REAL": "13328",
  "CORDOBA": "13330",
  "CUENCA": "13332",
  "GIPUZKOA": "13334",
  "GIRONA": "13336",
  "GRANADA": "13338",
  "GUADALAJARA": "13340",
  "HUELVA": "13342",
  "HUESCA": "13344",
  "ISLAS BALEARES / ILLES BALARS": "13312",
  "JAEN": "13346",
  "LA RIOJA": "13348",
  "LAS PALMAS": "13350",
  "LEON": "13352",
  "LLEIDA": "13354",
  "LUGO": "13356",
  "MADRID": "13358",
  "MALAGA": "13360",
  "MELILLA": "13362",
  "MURCIA": "13364",
  "NAVARRA": "13366",
  "OURENSE": "13368",
  "PALENCIA": "13370",
  "PONTEVEDRA": "13372",
  "SALAMANCA": "13374",
  "SANTA CRUZ DE TENERIFE": "13376",
  "SEGOVIA": "13378",
  "SEVILLA": "13380",
  "SORIA": "13382",
  "TARRAGONA": "13384",
  "TERUEL": "13386",
  "TOLEDO": "13388",
  "VALENCIA / VALENCIA": "13390",
  "VALLADOLID": "13392",
  "VIZCAYA / BIZKAIA": "13394",
  "ZAMORA": "13396",
  "ZARAGOZA": "13398"
};



// ====== MAPA sexo comprador (LEAD / PROSPECTO) ======
const MAP_SEXO_LEAD_BITRIX = {
  "HOMBRE": "38878",
  "MUJER": "38880",
  "SOCIEDAD": "38882"
};

// ====== MAPA sexo vendedor (LEAD / PROSPECTO) ======
const MAP_SEXO_VENDEDOR_LEAD_BITRIX = {
  "HOMBRE": "38884",
  "MUJER": "38886",
  "SOCIEDAD": "38888"
};

// ====== MAPA provincia comprador (LEAD / PROSPECTO) ======
const MAP_PROVINCIA_LEAD_BITRIX = {
  "A CORU√ëA": "38890",
  "ALAVA / ARABA": "38892",
  "ALBACETE": "38894",
  "ALICANTE / ALACANT": "38896",
  "ALMERIA": "38898",
  "ASTURIAS": "38900",
  "AVILA": "38902",
  "BADAJOZ": "38904",
  "BARCELONA": "38906",
  "BURGOS": "38908",
  "CACERES": "38910",
  "CADIZ": "38912",
  "CANTABRIA": "38914",
  "CASTELLON / CASTELLO": "38916",
  "CEUTA": "38918",
  "CIUDAD REAL": "38920",
  "CORDOBA": "38922",
  "CUENCA": "38924",
  "GIPUZKOA": "38926",
  "GIRONA": "38928",
  "GRANADA": "38930",
  "GUADALAJARA": "38932",
  "HUELVA": "38934",
  "HUESCA": "38936",
  "ISLAS BALEARES / ILLES BALARS": "38938",
  "JAEN": "38940",
  "LA RIOJA": "38942",
  "LAS PALMAS": "38944",
  "LEON": "38946",
  "LLEIDA": "38948",
  "LUGO": "38950",
  "MADRID": "38952",
  "MALAGA": "38954",
  "MELILLA": "38956",
  "MURCIA": "38958",
  "NAVARRA": "38960",
  "OURENSE": "38962",
  "PALENCIA": "38964",
  "PONTEVEDRA": "38966",
  "SALAMANCA": "38968",
  "SANTA CRUZ DE TENERIFE": "38970",
  "SEGOVIA": "38972",
  "SEVILLA": "38974",
  "SORIA": "38976",
  "TARRAGONA": "38978",
  "TERUEL": "38980",
  "TOLEDO": "38982",
  "VALENCIA / VALENCIA": "38984",
  "VALLADOLID": "38986",
  "VIZCAYA / BIZKAIA": "38988",
  "ZAMORA": "38990",
  "ZARAGOZA": "38992"
};
  // Modelo custom
  const modeloInput = document.getElementById("modeloInput");
  const modeloList  = document.getElementById("modeloList");
  const modeloPrev  = document.getElementById("modeloPreview");

  const fichaWrap = document.getElementById("fichaWrap");
  const btnWrap   = document.getElementById("btnWrap");
  const btnEnviar = document.getElementById("btnEnviar");
  const btnText   = document.getElementById("btnText");
  const btnProg   = document.getElementById("btnProgress");
  const msg       = document.getElementById("msg");
  
  // ============================
// MODO EDICI√ìN: ?Id=123
// ============================
function getLeadIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const id = (params.get("Id") || params.get("id") || "").trim();
  return /^\d+$/.test(id) ? id : null;
}

const LEAD_ID_EN_URL = getLeadIdFromUrl();

// (Opcional) feedback visual para ti
if (LEAD_ID_EN_URL) {
  console.log("‚úÖ Modo edici√≥n: actualizar Lead", LEAD_ID_EN_URL);
}

// ============================
// BOTON "APAGADO" HASTA OK
// ============================
function emailValido(s){
  const v = (s || "").trim();
  return !!v && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
}

function campoOk(id){
  const el = document.getElementById(id);
  if (!el) return true;
  return !!String(el.value || "").trim();
}

function v(id){ return (document.getElementById(id)?.value || "").trim(); }

function estaTodoOkParaEnviar(){
  const email = v("emailContacto");
  const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

  return (
    emailOk &&
    v("matriculaVehiculo") !== "" &&
    v("marca") !== "" &&
    !!fechaISO &&
    v("combustible") !== "" &&
    modeloOkGlobal() &&
    v("sexo") !== "" &&
    v("sexoVendedor") !== "" &&
    v("provinciaComprador") !== "" &&
    v("precioContrato") !== ""
  );
}
async function debugLeadStatuses(){
  const url = restBase + "crm.status.list.json?filter[ENTITY_ID]=STATUS";
  const r = await fetch(url);
  const j = await r.json();
  console.log("LEAD STATUSES:", j.result?.map(x => ({ID:x.STATUS_ID, NAME:x.NAME})));
}
debugLeadStatuses();
function debugEstadoEnviar(){
  const checks = {
    email: emailValido(emailContacto?.value),
    matricula: !!(matriculaVehiculo?.value || "").trim(),
    marca: !!(marcaSel?.value || "").trim(),
    fechaISO: !!fechaISO,
    combustible: !!(combSel?.value || "").trim(),
    modeloSeleccionado: modeloOkGlobal(),
    sexo: campoOk("sexo"),
    sexoVendedor: campoOk("sexoVendedor"),
    provinciaComprador: campoOk("provinciaComprador"),
    liqImpuestoTransmisiones: campoOk("liqImpuestoTransmisiones"),
    precioContrato: !!(document.getElementById("precioContrato")?.value || "").trim(),
  };

  console.table(checks);

  const fails = Object.entries(checks).filter(([k,v]) => !v).map(([k]) => k);
  if (fails.length) console.warn("FALTAN:", fails.join(", "));
  return fails;
}


function setBotonEnvioEncendido(on){
  btnEnviar.disabled = !on;

  // efecto apagado (SIN CSS)
  btnEnviar.style.transition = "opacity .2s ease, filter .2s ease";
  btnEnviar.style.opacity = on ? "1" : "0.35";
  btnEnviar.style.filter = on ? "none" : "grayscale(1)";
  btnEnviar.style.cursor = on ? "pointer" : "not-allowed";
}

function getVal(id){
  const el = document.getElementById(id);
  return (el?.value || "").trim();
}

function refrescarBotonEnviar(){
  // email SIEMPRE desde DOM
  const email = getVal("emailContacto");
  const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

  const ok = (
    emailOk &&
    getVal("matriculaVehiculo") !== "" &&
    getVal("marca") !== "" &&
    !!fechaISO &&
    getVal("combustible") !== "" &&
    modeloOkGlobal() &&
    getVal("sexo") !== "" &&
    getVal("sexoVendedor") !== "" &&
    getVal("provinciaComprador") !== "" &&
    getVal("precioContrato") !== ""
  );

  setBotonEnvioEncendido(ok);
}



  const ftMarca   = document.getElementById("ft_marca");
  const ftModelo  = document.getElementById("ft_modelo");
  const ftComb    = document.getElementById("ft_comb");
  const ftKw      = document.getElementById("ft_kw");
  const ftCv      = document.getElementById("ft_cv");
  const ftCvf     = document.getElementById("ft_cvf");
  const ftCc      = document.getElementById("ft_cc");
  const ftCil     = document.getElementById("ft_cil");
  const ftPeriodo = document.getElementById("ft_periodo");
  const ftFecha   = document.getElementById("ft_fecha");

  // Valor base + ajustado + uso/%
  const ftValorAjustado = document.getElementById("ft_valor_ajustado");
  const ftValorBase     = document.getElementById("ft_valor_base");
  const ftUsoPct        = document.getElementById("ft_uso_pct");

  // Fecha picker refs
  const fechaInput  = document.getElementById("fechaInput");
  const fechaOverlay= document.getElementById("fechaOverlay");
  const fechaModal  = document.getElementById("fechaModal");
  const fechaClose  = document.getElementById("fechaClose");
  const fechaPrev   = document.getElementById("fechaPrev");
  const fechaNext   = document.getElementById("fechaNext");
  const fechaBack   = document.getElementById("fechaBack");
  const fechaGrid   = document.getElementById("fechaGrid");
  const fechaCal    = document.getElementById("fechaCalendar");
  const fechaDays   = document.getElementById("fechaDays");
  const fechaTitle  = document.getElementById("fechaModalTitle");
  const fechaRange  = document.getElementById("fechaRangeLabel");

  let CATALOGO = [];
  let marcaObj = null;
  let modeloSeleccionado = null;
  


  // Fecha seleccionada
  let fechaISO = "";      // "YYYY-MM-DD"
  let anioMat = null;     // a√±o para filtrar modelos/combustibles

  let fechaStep = "year"; // year | month | day
  let yearPageStart = 2019;
  let pickedYear = null;
  let pickedMonth = null;

  const MESES = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  const COMBUSTIBLE_LABELS = {
    G:"Gasolina", D:"Di√©sel", E:"El√©ctrico", HEV:"H√≠brido",
    MHEV:"Microh√≠brido", PHEV:"H√≠brido enchufable",
    FHEV:"H√≠brido", S:"Gasolina", M:"Di√©sel y El√©ctrico",
    GLP:"Gasolina GLP", CNG:"Gasolina GNC", H2:"Hidr√≥geno"
  };
  const labelCombustible = c => COMBUSTIBLE_LABELS[c] || c;
  
function labelSexo(s){
  const v = (s || "").trim().toUpperCase();
  if (v === "HOMBRE") return "Hombre";
  if (v === "MUJER") return "Mujer";
  if (v === "SOCIEDAD") return "Sociedad";
  return v || "‚Äî";
}

function labelSiNo(b){
  return b ? "S√≠" : "No";
}

function txt(id, fallback="‚Äî"){
  const el = document.getElementById(id);
  const t = (el?.textContent || "").trim();
  return t || fallback;
}



  const getNum = (v, fallback="‚Äî") => (v === null || v === undefined || v === "" ? fallback : v);
  const getKW  = m => getNum(m?.potencia_kw ?? m?.kw);
  const getCV  = m => getNum(m?.potencia_cv ?? m?.cv);
  const getCC = (m) => getNum(
  m?.cilindrada_cc ??
  m?.cilindrada ??
  m?.cilindrada_ccm ??
  m?.cc ??
  m?.p1 ??          // a veces viene como P.1
  m?.engine_cc
);

const getCil = (m) => getNum(
  m?.num_cilindros ??
  m?.cilindros ??
  m?.n_cilindros ??
  m?.engine_cylinders
);

  const getCVF = m => {
    const v = m?.potencia_cvf ?? m?.cvf;
    if (v === null || v === undefined || v === "") return "‚Äî";
    const n = Number(v);
    if (!Number.isNaN(n)) return n.toLocaleString("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    return String(v);
  };

  const extraerAnio = v => (v ? String(v).match(/\b(19\d{2}|20\d{2})\b/)?.[1] : null);
  const getPeriodo = m => {
    const i = extraerAnio(m?.inicio_periodo);
    const f = extraerAnio(m?.fin_periodo);
    return (!i && !f) ? "‚Äî" : `${i || "?"}-${f || "0"}`;
  };

  const getValorRaw = m => {
    let n = Number(m?.valor_2026_eur);
    if (!n) return "";
    if (n < 1000) n *= 1000;
    return String(Math.round(n));
  };
  const getValorTxt = m => getValorRaw(m)
    ? Number(getValorRaw(m)).toLocaleString("es-ES") + " ‚Ç¨"
    : "‚Äî";

  function formatFechaES(iso){
    if (!iso) return "‚Äî";
    const [y,m,d] = iso.split("-");
    return `${d}-${m}-${y}`;
  }

function ocultarFicha() {
  fichaWrap.style.display = "none";
  btnWrap.style.display = "block";
  // üö´ NO toques modeloSeleccionado aqu√≠
  refrescarBotonEnviar();
}
  
  function getFechaReferenciaDepreciacion(){
  return new Date(); // HOY
}

  /* =========================
     VALOR AJUSTADO POR A√ëOS DE USO
  ========================= */

  function porcentajePorAniosUso(anios){
    if (anios <= 1)  return 100;
    if (anios <= 2)  return 84;
    if (anios <= 3)  return 67;
    if (anios <= 4)  return 56;
    if (anios <= 5)  return 47;
    if (anios <= 6)  return 39;
    if (anios <= 7)  return 34;
    if (anios <= 8)  return 28;
    if (anios <= 9)  return 24;
    if (anios <= 10) return 19;
    if (anios <= 11) return 17;
    if (anios <= 12) return 13;
    return 10;
  }

  function toYear(v){
    if (v === null || v === undefined || v === "") return null;
    const n = Number(v);
    if (!Number.isNaN(n) && n > 1900 && n < 2100) return n;
    const m = String(v).match(/\b(19\d{2}|20\d{2})\b/);
    return m ? Number(m[1]) : null;
  }

  function getFechaReferencia(modelo){
    const hoy = new Date();
    const finY = toYear(modelo?.fin_periodo);
    if (!finY) return hoy;
    const ref = new Date(finY, 11, 31, 23, 59, 59);
    return (ref > hoy) ? hoy : ref;
  }

  function calcularAniosUso(fechaIsoMat, fechaRef){
    if (!fechaIsoMat || !fechaRef) return null;
    const [y,m,d] = fechaIsoMat.split("-").map(n => parseInt(n,10));
    const mat = new Date(y, m-1, d);
    if (Number.isNaN(mat.getTime())) return null;
    if (mat > fechaRef) return 0;
    const ms = fechaRef.getTime() - mat.getTime();
    return ms / (365.25 * 24 * 60 * 60 * 1000);
  }

  function getValorAjustadoRaw(modelo){
    const baseStr = getValorRaw(modelo);
    const base = Number(baseStr);
    if (!base) return "";
    if (!fechaISO) return baseStr;
const refDate = getFechaReferenciaDepreciacion();
const aniosUso = calcularAniosUso(fechaISO, refDate);
    if (aniosUso === null) return baseStr;
    const pct = porcentajePorAniosUso(aniosUso);
    return String(Math.round(base * (pct / 100)));
  }

  function getValorAjustadoTxt(modelo){
    const raw = getValorAjustadoRaw(modelo);
    if (!raw) return "‚Äî";
    return Number(raw).toLocaleString("es-ES") + " ‚Ç¨";
  }

  function getUsoInfo(modelo){
    if (!fechaISO) return { pctTxt: "‚Äî", pct: null, anios: null };
    const refDate = getFechaReferenciaDepreciacion();
    const aniosUso = calcularAniosUso(fechaISO, refDate);
    if (aniosUso === null) return { pctTxt: "‚Äî", pct: null, anios: null };
    const pct = porcentajePorAniosUso(aniosUso);
    const anios1 = Math.round(aniosUso * 10) / 10;
    const aniosTxt = anios1.toLocaleString("es-ES", { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    return { pctTxt: `${aniosTxt} a√±os ¬∑ ${pct}%`, pct, anios: anios1 };
  }

  function renderFicha() {
    if (!modeloSeleccionado) { ocultarFicha(); return; }

    fichaWrap.style.display = "block";
    btnWrap.style.display = "block";

    ftMarca.textContent   = marcaSel.value;
    ftModelo.textContent  = modeloSeleccionado.nombre;
    ftComb.textContent    = labelCombustible(combSel.value);
    ftKw.textContent      = getKW(modeloSeleccionado);
    ftCv.textContent      = getCV(modeloSeleccionado);
    ftCvf.textContent     = getCVF(modeloSeleccionado);
    const esElectrico = (combSel.value === "E"); // seg√∫n tu tabla, E = El√©ctrico
ftCc.textContent  = getCC(modeloSeleccionado) === "‚Äî" && esElectrico ? "No aplica" : getCC(modeloSeleccionado);
ftCil.textContent = getCil(modeloSeleccionado) === "‚Äî" && esElectrico ? "No aplica" : getCil(modeloSeleccionado);

    ftPeriodo.textContent = getPeriodo(modeloSeleccionado);

    ftValorBase.textContent     = getValorTxt(modeloSeleccionado);
    ftValorAjustado.textContent = getValorAjustadoTxt(modeloSeleccionado);
    ftUsoPct.textContent        = getUsoInfo(modeloSeleccionado).pctTxt;

    ftFecha.textContent  = formatFechaES(fechaISO);
  }

  async function cargarCatalogo() {
    const res = await fetch(
      "https://raw.githubusercontent.com/oscarcerezohervasgestion-cell/catalogos-vehiculos/main/catalogo_vehiculos_2026.json",
      { cache: "no-store" }
    );
    if (!res.ok) throw new Error("HTTP " + res.status);
    CATALOGO = await res.json();
    if (!Array.isArray(CATALOGO)) throw new Error("JSON inv√°lido");

    CATALOGO.forEach(m => {
      const o = document.createElement("option");
      o.value = m.marca;
      o.textContent = m.marca;
      marcaSel.appendChild(o);
    });
  }

  /* =========================
     FILTRO POR A√ëO (anioMat)
  ========================= */

  function modeloValidoParaAnio(modelo, year){
    if (!year) return true;
    const ini = toYear(modelo?.inicio_periodo);
    const fin = toYear(modelo?.fin_periodo);
    if (!ini) return true;
    if (year < ini) return false;
    if (fin === null) return true;
    return year <= fin;
  }

  function getModelosFiltrados(combCode){
    const modelos = marcaObj?.modelos_por_combustible?.[combCode] || [];
    return modelos.filter(m => modeloValidoParaAnio(m, anioMat));
  }

function resetCombustibleModelo(){
  combSel.innerHTML = `<option value="">Selecciona combustible‚Ä¶</option>`;
  combSel.disabled = true;

  modeloInput.value = "";
  modeloInput.disabled = true;
  modeloList.style.display = "none";
  modeloList.innerHTML = "";
  modeloPrev.style.display = "none";

  // ‚úÖ aqu√≠ s√≠: estamos reseteando de verdad
  modeloSeleccionado = null;

  ocultarFicha();
}


  function cargarCombustiblesFiltrados(){
    combSel.innerHTML = `<option value="">Selecciona combustible‚Ä¶</option>`;
    combSel.disabled = true;

    modeloInput.value = "";
    modeloInput.disabled = true;
    modeloList.style.display = "none";
    modeloList.innerHTML = "";
    modeloPrev.style.display = "none";

    ocultarFicha();

    if (!marcaObj || !anioMat) return;

    const combustibles = marcaObj?.combustibles || [];
    const validos = combustibles.filter(c => getModelosFiltrados(c).length > 0);

    validos.forEach(c => combSel.add(new Option(labelCombustible(c), c)));
    combSel.disabled = false;
  }

  function renderModeloPreview(m){
    if (!m) { modeloPrev.style.display="none"; return; }

    const uso = getUsoInfo(m);
    const valorAdjTxt = getValorAjustadoTxt(m);

    modeloPrev.innerHTML = `
      <div style="font-weight:800;font-size:14px;margin-bottom:6px">${m.nombre}</div>
      <div style="opacity:.9;font-size:12px;line-height:1.45">
        <div><b>kW:</b> ${getKW(m)} &nbsp; <b>CV:</b> ${getCV(m)}</div>
        <div><b>CVF:</b> ${getCVF(m)} &nbsp; <b>cc:</b> ${getCC(m)}</div>

        <div style="margin-top:6px"><b>Periodo:</b> ${getPeriodo(m)}</div>

        <div style="margin-top:6px"><b>Valor base:</b> ${getValorTxt(m)}</div>

        <div style="margin-top:6px">
          <b>Uso / %:</b> ${uso.pctTxt}
        </div>

        <div style="margin-top:6px">
          <b>Valor ajustado:</b> ${valorAdjTxt}
        </div>

        ${!fechaISO ? `
          <div style="margin-top:6px;opacity:.85">
            <i>Elige fecha de matriculaci√≥n para ajustar</i>
          </div>
        ` : ``}
      </div>
    `;
    modeloPrev.style.display="block";
  }

function fmtEURfromNumber(n){
  if (n === null || n === undefined || !Number.isFinite(n)) return "‚Äî";
  return n.toLocaleString("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "‚Ç¨";
}
function fmtEURfromIntString(raw){
  if (!raw) return "‚Äî";
  const n = Number(raw);
  if (!Number.isFinite(n)) return "‚Äî";
  return n.toLocaleString("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "‚Ç¨";
}
function fmtPct(n){
  if (n === null || n === undefined || !Number.isFinite(n)) return "‚Äî";
  return n.toLocaleString("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%";
}

// Convierte "15,23" / "15.23" / "15" / "‚Äî" => number|null
function parseCVFtoNumber(cvfTxt){
  if (!cvfTxt) return null;
  const s = String(cvfTxt).trim();
  if (!s || s === "‚Äî") return null;

  // Si tiene coma, asumimos formato ES: "15.234,56"
  if (s.includes(",")) {
    const n = Number(s.replace(/\./g, "").replace(",", "."));
    return Number.isFinite(n) ? n : null;
  }

  // Si NO tiene coma, asumimos punto decimal normal: "15.23" o entero "15"
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function parseEURtoNumber(txt){
  if (!txt) return null;
  let s = String(txt).trim();
  if (!s) return null;

  s = s.replace(/[^\d,\.]/g, "");

  // Si hay coma, coma es decimal y los puntos son miles
  if (s.includes(",")) {
    s = s.replace(/\./g, "").replace(",", ".");
  } else {
    // Si no hay coma, el punto (si existe) es decimal
    // pero si hay muchos puntos, asumimos que eran miles
    const parts = s.split(".");
    if (parts.length > 2) {
      s = s.replace(/\./g, "");
    }
  }

  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

// cc viene como "1.998" o "1998" o "‚Äî"
function parseCCtoNumber(ccTxt){
  if (!ccTxt) return null;
  const s = String(ccTxt).replace(/\D/g, ""); // solo d√≠gitos
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function calcularITPProvincia(provinciaTxt, cvfNum, ccNum, aniosUso, baseFinalNum){ 
 const p = normTxt(provinciaTxt);

  /* =========================================================
     ANDALUC√çA
     - En tu funci√≥n actual est√° dentro del "RESTO" como 4%
  ========================================================= */
  // (No bloque espec√≠fico aqu√≠; se gestiona en RESTO con TIPO_4_PCT)

  /* =========================================================
     ARAG√ìN (Huesca / Teruel / Zaragoza)
  ========================================================= */
  const ES_ARAGON = ["HUESCA","TERUEL","ZARAGOZA"].includes(p);
  if (ES_ARAGON) {
    if (Number.isFinite(aniosUso) && aniosUso > 10 && Number.isFinite(ccNum) && ccNum <= 2000) {
      if (ccNum <= 1000) return { tipoTxt: "No obligados", cuotaNum: 0 };
      if (ccNum <= 1500) return { tipoTxt: "Cuota fija", cuotaNum: 20 };
      return { tipoTxt: "Cuota fija", cuotaNum: 30 };
    }
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "4,00%", cuotaNum: null };
    return { tipoTxt: "4,00%", cuotaNum: baseFinalNum * 0.04 };
  }

  /* =========================================================
     ASTURIAS
     - En tu funci√≥n actual est√° dentro del "RESTO" como 4%
  ========================================================= */
  // (No bloque espec√≠fico aqu√≠; se gestiona en RESTO con TIPO_4_PCT)

  /* =========================================================
     BALEARES
     - En tu funci√≥n actual est√° dentro del "RESTO" como 4%
  ========================================================= */
  // (No bloque espec√≠fico aqu√≠; se gestiona en RESTO con TIPO_4_PCT)

  /* =========================================================
     CANARIAS (Las Palmas / Santa Cruz de Tenerife)
  ========================================================= */
  const ES_CANARIAS = ["LAS PALMAS", "SANTA CRUZ DE TENERIFE"].includes(p);
  if (ES_CANARIAS) {
    if (Number.isFinite(aniosUso) && aniosUso > 10 && Number.isFinite(ccNum)) {
      if (ccNum < 1000)  return { tipoTxt: "Cuota fija", cuotaNum: 40 };
      if (ccNum <= 1500) return { tipoTxt: "Cuota fija", cuotaNum: 70 };
      if (ccNum <= 2000) return { tipoTxt: "Cuota fija", cuotaNum: 115 };
    }
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "5,50%", cuotaNum: null };
    return { tipoTxt: "5,50%", cuotaNum: baseFinalNum * 0.055 };
  }

  /* =========================================================
     CANTABRIA
  ========================================================= */
  if (p === "CANTABRIA") {
    if (Number.isFinite(aniosUso) && aniosUso > 10 && Number.isFinite(ccNum)) {
      if (ccNum <= 999)  return { tipoTxt: "Cuota fija", cuotaNum: 45 };
      if (ccNum <= 1499) return { tipoTxt: "Cuota fija", cuotaNum: 60 };
      if (ccNum <= 1999) return { tipoTxt: "Cuota fija", cuotaNum: 90 };
    }
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "6,00%", cuotaNum: null };
    return { tipoTxt: "6,00%", cuotaNum: baseFinalNum * 0.06 };
  }

  /* =========================================================
     CASTILLA Y LE√ìN (NUEVO)
     - CVF > 15 => 8%
     - CVF <= 15 => 5%
  ========================================================= */
const ES_CASTILLA_Y_LEON = [
  "AVILA","BURGOS","LEON","PALENCIA","SALAMANCA",
  "SEGOVIA","SORIA","VALLADOLID","ZAMORA"
].includes(p);

  if (ES_CASTILLA_Y_LEON) {
    const pct = (cvfNum !== null && cvfNum > 15) ? 8 : 5;
    const pctTxt = pct.toFixed(2).replace(".", ",") + "%";
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: pctTxt, cuotaNum: null };
    return { tipoTxt: pctTxt, cuotaNum: baseFinalNum * (pct / 100) };
  }

  /* =========================================================
     CASTILLA-LA MANCHA + EXTREMADURA (SIEMPRE 6%)
  ========================================================= */
  const SIEMPRE_6_PCT = ["ALBACETE","CIUDAD REAL","CUENCA","GUADALAJARA","TOLEDO","BADAJOZ","CACERES"];
  if (SIEMPRE_6_PCT.includes(p)) {
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "6,00%", cuotaNum: null };
    return { tipoTxt: "6,00%", cuotaNum: baseFinalNum * 0.06 };
  }

  /* =========================================================
     CATALU√ëA
  ========================================================= */
  const ES_CATALUNA = ["BARCELONA","GIRONA","LLEIDA","TARRAGONA"].includes(p);
  if (ES_CATALUNA) {
    if (Number.isFinite(aniosUso) && aniosUso >= 10) {
      if (Number.isFinite(baseFinalNum) && baseFinalNum >= 40000) {
        return { tipoTxt: "5,00%", cuotaNum: baseFinalNum * 0.05 };
      }
      return { tipoTxt: "No obligados", cuotaNum: 0 };
    }
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "5,00%", cuotaNum: null };
    return { tipoTxt: "5,00%", cuotaNum: baseFinalNum * 0.05 };
  }

  /* =========================================================
     CEUTA
  ========================================================= */
  if (p === "CEUTA") {
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "4,00%", cuotaNum: null };
    return { tipoTxt: "4,00%", cuotaNum: baseFinalNum * 0.04 };
  }

  /* =========================================================
     COMUNIDAD VALENCIANA
  ========================================================= */
  const ES_CV = ["VALENCIA / VALENCIA", "ALICANTE / ALACANT", "CASTELLON / CASTELLO"].includes(p);
  if (ES_CV) {
    const a√±os = Number.isFinite(aniosUso) ? aniosUso : null;
    const base = Number.isFinite(baseFinalNum) ? baseFinalNum : null;
    const cc   = Number.isFinite(ccNum) ? ccNum : null;

    if (a√±os !== null && base !== null && a√±os >= 5 && base < 20000) {
      if (a√±os > 12) {
        if (cc === null) return { tipoTxt: "Cuota fija", cuotaNum: null };
        if (cc <= 1500) return { tipoTxt: "Cuota fija", cuotaNum: 40 };
        if (cc <= 2000) return { tipoTxt: "Cuota fija", cuotaNum: 60 };
        return { tipoTxt: "Cuota fija", cuotaNum: 140 };
      }
      if (cc === null) return { tipoTxt: "Cuota fija", cuotaNum: null };
      if (cc <= 1500) return { tipoTxt: "Cuota fija", cuotaNum: 120 };
      if (cc <= 2000) return { tipoTxt: "Cuota fija", cuotaNum: 180 };
      return { tipoTxt: "Cuota fija", cuotaNum: 280 };
    }

    if (a√±os !== null && a√±os <= 12 && cc !== null && cc > 2000 && base !== null && base >= 20000) {
      return { tipoTxt: "8,00%", cuotaNum: base * 0.08 };
    }

    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "6,00%", cuotaNum: null };
    return { tipoTxt: "6,00%", cuotaNum: baseFinalNum * 0.06 };
  }

  /* =========================================================
     GALICIA
  ========================================================= */
  const ES_GALICIA = ["A CORU√ëA","LUGO","OURENSE","PONTEVEDRA"].includes(p);
  if (ES_GALICIA) {
    if (Number.isFinite(aniosUso) && aniosUso >= 15 && Number.isFinite(ccNum)) {
      if (ccNum < 1199) return { tipoTxt: "Cuota fija", cuotaNum: 22 };
      if (ccNum >= 1200 && ccNum <= 1599) return { tipoTxt: "Cuota fija", cuotaNum: 38 };
    }
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "3,00%", cuotaNum: null };
    return { tipoTxt: "3,00%", cuotaNum: baseFinalNum * 0.03 };
  }

  /* =========================================================
     LA RIOJA / MADRID / MELILLA / √ÅLAVA / VIZCAYA / GIPUZKOA
     - Siempre 4%
  ========================================================= */
const SIEMPRE_4_PCT = ["LA RIOJA","MADRID","MELILLA","ALAVA / ARABA","VIZCAYA / BIZKAIA","GIPUZKOA"];
  if (SIEMPRE_4_PCT.includes(p)) {
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "4,00%", cuotaNum: null };
    return { tipoTxt: "4,00%", cuotaNum: baseFinalNum * 0.04 };
  }

  /* =========================================================
     MURCIA
  ========================================================= */
  if (p === "MURCIA") {
    if (Number.isFinite(aniosUso) && aniosUso >= 12 && Number.isFinite(ccNum)) {
      if (ccNum < 1000)  return { tipoTxt: "No obligados", cuotaNum: 0 };
      if (ccNum <= 1500) return { tipoTxt: "Cuota fija", cuotaNum: 30 };
      if (ccNum <= 2000) return { tipoTxt: "Cuota fija", cuotaNum: 50 };
      return { tipoTxt: "Cuota fija", cuotaNum: 75 };
    }
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "4,00%", cuotaNum: null };
    return { tipoTxt: "4,00%", cuotaNum: baseFinalNum * 0.04 };
  }

  /* =========================================================
     NAVARRA
  ========================================================= */
  if (p === "NAVARRA") {
    if (Number.isFinite(aniosUso) && aniosUso > 10 && Number.isFinite(baseFinalNum) && baseFinalNum < 40000) {
      return { tipoTxt: "No obligados", cuotaNum: 0 };
    }
    if (!Number.isFinite(baseFinalNum)) return { tipoTxt: "4,00%", cuotaNum: null };
    return { tipoTxt: "4,00%", cuotaNum: baseFinalNum * 0.04 };
  }

  /* =========================================================
     RESTO
     - Base general 5%
     - Andaluc√≠a + Asturias + Baleares: 4%
     - Si CVF > 15 => 8%
  ========================================================= */
  let pct = 5;

  const TIPO_4_PCT = [
  "SEVILLA","CADIZ","MALAGA","GRANADA","CORDOBA","HUELVA","JAEN","ALMERIA",
  "ASTURIAS",
  "ISLAS BALEARES / ILLES BALARS"
];
  if (TIPO_4_PCT.includes(p)) pct = 4;

  if (cvfNum !== null && cvfNum > 15) pct = 8;

  const pctTxt = pct.toFixed(2).replace(".", ",") + "%";
  if (!Number.isFinite(baseFinalNum)) return { tipoTxt: pctTxt, cuotaNum: null };
  return { tipoTxt: pctTxt, cuotaNum: baseFinalNum * (pct / 100) };
}







function itpAplicaSegunVendedor(){
  const sexoV = (document.getElementById("sexoVendedor")?.value || "").trim();
  const esAutonomo = !!document.getElementById("autonomoVendedor")?.checked;

  // SOCIEDAD => nunca ITP
  if (sexoV === "SOCIEDAD") return false;

  // HOMBRE/MUJER: si es aut√≥nomo => no ITP
  if (sexoV === "HOMBRE" || sexoV === "MUJER") return !esAutonomo;

  // si no han elegido sexo vendedor, por seguridad NO calculamos ITP
  return false;
}

// ====== GASTOS FIJOS (SIEMPRE) ======
const GASTOS_FIJOS = {
  tasaTrafico: 55.70,
  tasaExtra: 5.75,

  // ‚úÖ Unificado: Expediente + Gesti√≥n => 77,00‚Ç¨
  gestionHervas: 77.00,

  ivaPct: 21
};

function getIvaEG(){
  const base = GASTOS_FIJOS.gestionHervas;
  return Number((base * (GASTOS_FIJOS.ivaPct / 100)).toFixed(2));
}

function getTotalSoloGastos(){
  const iva = getIvaEG();
  return Number((
    GASTOS_FIJOS.tasaTrafico +
    GASTOS_FIJOS.tasaExtra +
    GASTOS_FIJOS.gestionHervas +
    iva
  ).toFixed(2));
}

function actualizarPresupuestoITP(){
      // ‚úÖ coger los elementos aqu√≠ evita "before initialization"
  const elValoracion = document.getElementById("itp_valoracion_inicial");
  const elFactor     = document.getElementById("itp_factor");
  const elBase       = document.getElementById("itp_base");
  const elTipo       = document.getElementById("itp_tipo");
  const elCuota      = document.getElementById("itp_cuota");
  const elTotal      = document.getElementById("itp_total");
  const elGestionHervas = document.getElementById("itp_gestion_hervas");
const elIvaGestion    = document.getElementById("itp_iva_gestion_hervas");

  // Si a√∫n no est√°n en el DOM, no rompas nada
  if (!elValoracion || !elFactor || !elBase || !elTipo || !elCuota || !elTotal) return;
    console.log("modeloSeleccionado:", !!modeloSeleccionado, modeloSeleccionado?.nombre);
console.log("sexoVendedor:", document.getElementById("sexoVendedor")?.value);
console.log("autonomo:", !!document.getElementById("autonomoVendedor")?.checked);
console.log("provincia:", document.getElementById("provinciaComprador")?.value);
// ‚úÖ Limpieza anti-arrastre SIEMPRE
elValoracion.textContent = "‚Äî";
elFactor.textContent     = "‚Äî";
elBase.textContent       = "‚Äî";
elTipo.textContent       = "‚Äî";
elCuota.textContent      = "‚Äî";
elTotal.textContent      = "‚Äî";
if (elGestionHervas) elGestionHervas.textContent = "‚Äî";
if (elIvaGestion)    elIvaGestion.textContent    = "‚Äî";

// ‚úÖ AHORA: pintar siempre valores fijos
if (elGestionHervas) elGestionHervas.textContent = fmtEURfromNumber(GASTOS_FIJOS.gestionHervas);
if (elIvaGestion)    elIvaGestion.textContent    = fmtEURfromNumber(getIvaEG());

// ‚úÖ MODO MANUAL: no calcular ITP, pero si NO aplica (sociedad/aut√≥nomo) lo mostramos
if (modoManualActivo()) {
  const totalSoloGastos = getTotalSoloGastos();
  const aplicaITP = itpAplicaSegunVendedor();

  if (!aplicaITP) {
    elTipo.textContent  = "No aplica";
    elCuota.textContent = fmtEURfromNumber(0);
  } else {
    elTipo.textContent  = "‚Äî";
    elCuota.textContent = "‚Äî";
  }

  elTotal.textContent = fmtEURfromNumber(totalSoloGastos);
  return;
}


if (!modeloSeleccionado) return;

  const aplicaITP = itpAplicaSegunVendedor();
  const totalSoloGastos = getTotalSoloGastos();

  // ‚úÖ Si NO aplica ITP (aut√≥nomo o sociedad): total = SOLO GASTOS
  if (!aplicaITP) {
    elTipo.textContent  = "No aplica";
    elCuota.textContent = fmtEURfromNumber(0);
    elTotal.textContent = fmtEURfromNumber(totalSoloGastos);
    return;
  }

  // ‚úÖ Si aplica ITP, ahora s√≠ pedimos provincia
  const provincia = (document.getElementById("provinciaComprador")?.value || "").trim();
  if (!provincia) return; // se queda todo en "‚Äî" (ya limpio arriba)

  // 1) Valoraci√≥n inicial = Valor base 2026
  const valorBaseRaw = getValorRaw(modeloSeleccionado);
  const valorBaseNum = valorBaseRaw ? Number(valorBaseRaw) : null;

  // 2) Factor correcci√≥n = % a√±os de uso
  const usoInfo   = getUsoInfo(modeloSeleccionado);
  const factorPct = Number.isFinite(usoInfo?.pct) ? usoInfo.pct : null;

  // 3) Base por tablas
  const baseImpRawTablas = getValorAjustadoRaw(modeloSeleccionado);
  const baseImpNumTablas = baseImpRawTablas ? Number(baseImpRawTablas) : null;

  // Precio contrato
  const precioTxt = (document.getElementById("precioContrato")?.value || "").trim();
  const precioNum = parseEURtoNumber(precioTxt);

  // Base final = mayor entre tablas y precio
  let baseFinalNum = baseImpNumTablas;
  let baseFinalRaw = baseImpRawTablas;

  if (precioNum !== null && baseImpNumTablas !== null && precioNum > baseImpNumTablas) {
    baseFinalNum = precioNum;
    baseFinalRaw = String(Math.round(precioNum));
  }

// 4) ITP (con cuotas fijas / no obligados / %)
const cvfNum2  = parseCVFtoNumber(getCVF(modeloSeleccionado));
const ccNum    = parseCCtoNumber(getCC(modeloSeleccionado));
const aniosUso = getUsoInfo(modeloSeleccionado)?.anios;

const itpCalc = calcularITPProvincia(provincia, cvfNum2, ccNum, aniosUso, baseFinalNum);
const itpCuota = (itpCalc && Number.isFinite(itpCalc.cuotaNum)) ? itpCalc.cuotaNum : null;

// 6) Total = ITP + gastos fijos
const total = (itpCuota !== null)
  ? Number((itpCuota + totalSoloGastos).toFixed(2))
  : null;

// pintar TODO (esto recupera tu progreso)
elValoracion.textContent = fmtEURfromIntString(valorBaseRaw);
elFactor.textContent     = (factorPct !== null) ? fmtPct(factorPct) : "‚Äî";
elBase.textContent       = fmtEURfromIntString(baseFinalRaw);

elTipo.textContent       = itpCalc?.tipoTxt ?? "‚Äî";
elCuota.textContent      = fmtEURfromNumber(itpCuota);
elTotal.textContent      = fmtEURfromNumber(total);

}

function setNeedIcon(id, ok) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = ok ? "‚úì" : "‚úó";
  el.style.color = ok ? "#16a34a" : "#ff3b30"; // verde / rojo
}

function actualizarNecesariosPresupuesto() {
  const marcaOk = !!(marcaSel?.value || "").trim();
  const fechaOk = !!fechaISO;
  const combOk  = !!(combSel?.value || "").trim();

  // ‚úÖ IMPORTANTE: ‚ÄúModelo‚Äù real = modeloSeleccionado (no el input)
  const modeloOk = modeloOkGlobal();

  const wrapProv = document.getElementById("wrapProvinciaComprador");
  const provSel  = document.getElementById("provinciaComprador");
  const provVisible = !wrapProv || wrapProv.style.display !== "none";
  const provOk = !provVisible || !!(provSel?.value || "").trim(); 
  // si est√° oculto por tus reglas, lo damos por OK

  setNeedIcon("need_marca_icon",  marcaOk);
  setNeedIcon("need_fecha_icon",  fechaOk);
  setNeedIcon("need_comb_icon",   combOk);
  setNeedIcon("need_modelo_icon", modeloOk);
  setNeedIcon("need_prov_icon",   provOk);
}

// Llamada inicial
actualizarNecesariosPresupuesto();


// Refrescar cuando cambia precio/liquidaci√≥n (aunque ahora no afecten al c√°lculo, lo dejamos listo)
document.getElementById("precioContrato")
  ?.addEventListener("input", actualizarPresupuestoITP);
  document.getElementById("provinciaComprador")
  ?.addEventListener("change", () => {
    actualizarPresupuestoITP();
    actualizarNecesariosPresupuesto(); 
    });
    
    document.getElementById("sexoVendedor")
  ?.addEventListener("change", () => {
    actualizarPresupuestoITP();
    actualizarNecesariosPresupuesto();
  });

document.getElementById("autonomoVendedor")
  ?.addEventListener("change", () => {
    actualizarPresupuestoITP();
    actualizarNecesariosPresupuesto();
  });

// ============================
// COMBOBOX MODELO: filtro + no texto libre
// ============================
let MODELOS_ACTUALES = [];

function normLite(s){
  return (s ?? "")
    .toString()
    .trim()
    .toUpperCase()
    // conservar √ë
    .replace(/√ë/g, "__ENYE__")
    .normalize("NFD")
    .replace(/[ÃÄ-ÕØ]/g, "")
    .replace(/__ENYE__/g, "√ë");
}

function abrirListaModelo(){
  if (modeloInput.disabled) return;
  modeloList.style.display = "block";
  renderListaModelosFiltrada(modeloInput.value);
}

function marcarNoSeleccionadoModelo(){
  // Si el usuario est√° tecleando, ya NO hay selecci√≥n v√°lida
  modeloInput.dataset.selected = "0";
  modeloSeleccionado = null;
  ocultarFicha();
  actualizarPresupuestoITP();
  actualizarNecesariosPresupuesto();
  refrescarBotonEnviar();
}

function renderListaModelosFiltrada(term){
  if (!modeloList) return;

  const t = normLite(term);
  const visibles = !t
    ? MODELOS_ACTUALES
    : MODELOS_ACTUALES.filter(m => normLite(m.nombre).includes(t));

  modeloList.innerHTML = "";

  if (!visibles.length){
    const empty = document.createElement("div");
    empty.style.cssText = "padding:10px 12px;font-size:13px;color:#667;";
    empty.textContent = "No hay resultados. Sigue escribiendo‚Ä¶";
    modeloList.appendChild(empty);
    return;
  }

  visibles.forEach(m => {
    const item = document.createElement("div");
    item.setAttribute(
      "style",
      "padding:10px 12px;border-bottom:1px solid #f0f0f0;cursor:pointer;font-size:13px;line-height:1.25"
    );

    const parts = [m.nombre, `${getKW(m)} kW`];

    const cc = getCC(m);
    if (cc !== "‚Äî") parts.push(`${cc} cc`);

    const cv = getCV(m);
    if (cv !== "‚Äî") parts.push(`${cv} CV`);

    const cvf = getCVF(m);
    if (cvf !== "‚Äî") parts.push(`${cvf} CVF`);

    const per = getPeriodo(m);
    if (per !== "‚Äî") parts.push(per);

    item.textContent = parts.join(" ¬∑ ");

    item.onmouseenter = () => renderModeloPreview(m);
    item.onmouseleave = () => { modeloPrev.style.display = "none"; };

    item.addEventListener("mousedown", (e) => {
  e.preventDefault(); // clave: evita que el input pierda foco antes de tiempo
  modeloSeleccionado = m;
  modeloInput.value = m.nombre;
  modeloInput.dataset.selected = "1";

  modeloList.style.display = "none";
  if (modeloPrev) modeloPrev.style.display = "none";

  actualizarPresupuestoITP();
  renderFicha();
  actualizarNecesariosPresupuesto();
  refrescarBotonEnviar();
});


    modeloList.appendChild(item);
  });
}


function cargarModelosFiltrados(){
  modeloSeleccionado = null;
  ocultarFicha();

  modeloInput.value = "";
  modeloInput.disabled = true;
  modeloInput.dataset.selected = "0";

  modeloList.style.display = "none";
  modeloList.innerHTML = "";
  modeloPrev.style.display = "none";

  if (!marcaObj || !anioMat || !combSel.value) return;

  MODELOS_ACTUALES = getModelosFiltrados(combSel.value);
  if (!MODELOS_ACTUALES.length) return;

  modeloInput.disabled = false;

  // Abrir lista
  modeloInput.onfocus = abrirListaModelo;
  modeloInput.onclick = abrirListaModelo;

  // üîé Escribir = filtrar (pero invalida selecci√≥n)
  modeloInput.oninput = () => {
    marcarNoSeleccionadoModelo();
    abrirListaModelo();
  };

  // ‚úÖ Si sale del input sin haber elegido un item -> limpiar
  modeloInput.onblur = () => {
    setTimeout(() => {
      // si el dropdown se cerr√≥ por click en item, dataset.selected ser√° "1"
      const selected = modeloInput.dataset.selected === "1";
      if (!selected){
        modeloInput.value = "";
        modeloList.style.display = "none";
        modeloPrev.style.display = "none";
        actualizarNecesariosPresupuesto();
        refrescarBotonEnviar();
      }
    }, 120); // deja tiempo para click
  };

  // primera render
  renderListaModelosFiltrada("");
}


  // ====== Marca/Combustible/Modelo (CON FILTRO) ======
marcaSel.onchange = () => {
  marcaObj = CATALOGO.find(m => m.marca === marcaSel.value) || null;

  // resetea lo dependiente de marca
  resetCombustibleModelo();

  // ‚úÖ SIEMPRE refresca los "datos necesarios"
  actualizarNecesariosPresupuesto();

  // si no hay marca v√°lida, paro aqu√≠
  if (!marcaObj) return;

  // si ya hay fecha, entonces s√≠ cargo combustibles
  if (anioMat) cargarCombustiblesFiltrados();
  refrescarBotonEnviar(); 
};

  combSel.onchange = () => {
    cargarModelosFiltrados();
    actualizarNecesariosPresupuesto();
    refrescarBotonEnviar();
  };

  // ====== Date Picker (A√±o -> Mes -> D√≠a) ======
  function openFechaModal(){
    fechaOverlay.style.display = "block";
    fechaModal.style.display = "block";

    if (fechaISO) {
      const [y,m] = fechaISO.split("-").map(n => parseInt(n,10));
      pickedYear = y;
      pickedMonth = m - 1;
      fechaStep = "day";
    } else {
      const now = new Date();
      pickedYear = null;
      pickedMonth = null;
      fechaStep = "year";
      const cy = now.getFullYear();
      yearPageStart = cy - (cy % 8);
      if (yearPageStart > cy) yearPageStart -= 8;
    }
    renderFechaStep();
  }

  function closeFechaModal(){
    fechaOverlay.style.display = "none";
    fechaModal.style.display = "none";
  }

  function startOfMonth(y, m){ return new Date(y, m, 1); }
  function daysInMonth(y, m){ return new Date(y, m + 1, 0).getDate(); }
  function toISO(y, m, d){
    const mm = String(m + 1).padStart(2,"0");
    const dd = String(d).padStart(2,"0");
    return `${y}-${mm}-${dd}`;
  }

  function renderYears(){
    fechaTitle.textContent = "Selecciona a√±o";
    fechaBack.style.display = "none";
    fechaCal.style.display = "none";
    fechaGrid.style.display = "grid";

    const hoy = new Date();
    const yearNow = hoy.getFullYear();

    fechaRange.textContent = `${yearPageStart} - ${yearPageStart + 7}`;
    fechaGrid.style.gridTemplateColumns = "repeat(4, 1fr)";
    fechaGrid.innerHTML = "";

    for (let y = yearPageStart; y < yearPageStart + 8; y++){
      const isFutureYear = y > yearNow;
      const isActive = pickedYear === y;

      const b = document.createElement("button");
      b.type = "button";
      b.textContent = String(y);

      b.setAttribute("style", `
        width:100%;
        padding:10px 8px;
        border-radius:10px;
        border:1px solid ${isFutureYear ? "#eee" : (isActive ? "rgba(6,26,74,.25)" : "#e6e6e6")};
        background:${isFutureYear ? "#f5f5f5" : (isActive ? "rgba(6,26,74,.06)" : "#fff")};
        cursor:${isFutureYear ? "not-allowed" : "pointer"};
        font-weight:${isActive ? "900" : "700"};
        color:${isFutureYear ? "#aaa" : "#061a4a"};
        box-sizing:border-box;
      `);

      if (isFutureYear) {
        b.title = "A√±o no disponible todav√≠a";
      } else {
        b.onclick = () => { pickedYear = y; fechaStep = "month"; renderFechaStep(); };
      }

      fechaGrid.appendChild(b);
    }

    fechaPrev.onclick = () => { yearPageStart -= 8; renderYears(); };
    fechaNext.onclick = () => { yearPageStart += 8; renderYears(); };
  }

  function renderMonths(){
    fechaTitle.textContent = "Selecciona mes";
    fechaBack.style.display = "inline-block";
    fechaCal.style.display = "none";
    fechaGrid.style.display = "grid";

    const hoy = new Date();
    const yearNow = hoy.getFullYear();
    const monthNow = hoy.getMonth();

    const y = pickedYear ?? yearNow;
    fechaRange.textContent = String(y);

    fechaGrid.style.gridTemplateColumns = "repeat(4, 1fr)";
    fechaGrid.innerHTML = "";

    for (let i = 0; i < 12; i++){
      const isActive = pickedMonth === i;
      const isFutureMonth = (y === yearNow) && (i > monthNow);

      const b = document.createElement("button");
      b.type = "button";
      b.textContent = MESES[i];

      b.setAttribute("style", `
        width:100%;
        padding:10px 8px;
        border-radius:10px;
        border:1px solid ${isFutureMonth ? "#eee" : (isActive ? "rgba(6,26,74,.25)" : "#e6e6e6")};
        background:${isFutureMonth ? "#f5f5f5" : (isActive ? "rgba(6,26,74,.06)" : "#fff")};
        cursor:${isFutureMonth ? "not-allowed" : "pointer"};
        font-weight:${isActive ? "900" : "700"};
        color:${isFutureMonth ? "#aaa" : "#061a4a"};
        box-sizing:border-box;
      `);

      if (isFutureMonth) {
        b.title = "Mes no disponible todav√≠a";
      } else {
        b.onclick = () => { pickedMonth = i; fechaStep = "day"; renderFechaStep(); };
      }

      fechaGrid.appendChild(b);
    }

    fechaBack.onclick = () => { fechaStep = "year"; renderFechaStep(); };
    fechaPrev.onclick = () => { pickedYear = y - 1; renderMonths(); };
    fechaNext.onclick = () => { pickedYear = y + 1; renderMonths(); };
  }

  function renderDays(){
    fechaTitle.textContent = "Selecciona d√≠a";
    fechaBack.style.display = "inline-block";
    fechaGrid.style.display = "none";
    fechaCal.style.display = "block";

    const y = pickedYear ?? new Date().getFullYear();
    const m = pickedMonth ?? new Date().getMonth();

    const hoy = new Date();
    const hoyISO = toISO(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

    fechaRange.textContent = `${MESES[m]} ${y}`;
    fechaDays.innerHTML = "";

    const first = startOfMonth(y, m);
    let weekday = (first.getDay() + 6) % 7;
    const total = daysInMonth(y, m);
    const selected = fechaISO;

    for (let i = 0; i < weekday; i++){
      const pad = document.createElement("div");
      pad.setAttribute("style","height:36px");
      fechaDays.appendChild(pad);
    }

    for (let d = 1; d <= total; d++){
      const iso = toISO(y, m, d);
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = String(d);

      const isSel = (selected === iso);
      const isFuture = (iso > hoyISO);

      b.setAttribute("style", `
        height:36px;
        border-radius:10px;
        border:1px solid ${isFuture ? "#eee" : isSel ? "rgba(255,91,46,.55)" : "#e6e6e6"};
        background:${isFuture ? "#f5f5f5" : isSel ? "rgba(255,91,46,.14)" : "#fff"};
        cursor:${isFuture ? "not-allowed" : "pointer"};
        font-weight:${isSel ? "900" : "700"};
        color:${isFuture ? "#aaa" : (isSel ? "#ff5b2e" : "#061a4a")};
      `);

      if (isFuture) b.title = "Fecha no v√°lida";

      if (!isFuture) {
        b.onclick = () => {
  fechaISO = iso;
  anioMat = y;
  fechaInput.value = formatFechaES(fechaISO);
  closeFechaModal();

  msg.textContent = "";
  msg.style.color = "#061a4a";

if (marcaSel.value) {
  marcaObj = CATALOGO.find(m => m.marca === marcaSel.value) || null;

  // ‚úÖ Si ya hay combustible y modelo elegido, NO resetees nada.
  // Solo recalcula con la nueva fecha.
  if (combSel.value && modeloSeleccionado) {
    renderFicha();
    actualizarPresupuestoITP();
  } else {
    // Si todav√≠a no hay selecci√≥n completa, entonces s√≠ resetea y recarga
    resetCombustibleModelo();
    if (marcaObj) cargarCombustiblesFiltrados();
  }
}


  if (modeloSeleccionado) {
    renderFicha();
    actualizarPresupuestoITP();
    
  }
  actualizarNecesariosPresupuesto();
  refrescarBotonEnviar();
};

      }

      fechaDays.appendChild(b);
    }

    fechaBack.onclick = () => { fechaStep = "month"; renderFechaStep(); };

    fechaPrev.onclick = () => {
      let ny = y, nm = m - 1;
      if (nm < 0) { nm = 11; ny = y - 1; }
      pickedYear = ny; pickedMonth = nm;
      renderDays();
    };

    fechaNext.onclick = () => {
      let ny = y, nm = m + 1;
      if (nm > 11) { nm = 0; ny = y + 1; }
      pickedYear = ny; pickedMonth = nm;
      renderDays();
    };
  }

  function renderFechaStep(){
    if (fechaStep === "year") renderYears();
    if (fechaStep === "month") renderMonths();
    if (fechaStep === "day") renderDays();
  }

  fechaInput.onclick = openFechaModal;
  fechaOverlay.onclick = closeFechaModal;
  fechaClose.onclick = closeFechaModal;

  // ======= Bot√≥n progreso =======
  let progressInterval = null;
  let progressValue = 0;

  function startProgress() {
    progressValue = 0;
    btnProg.style.width = "0%";
    progressInterval = setInterval(() => {
      if (progressValue < 90) {
        progressValue += Math.random() * 6;
        btnProg.style.width = Math.min(progressValue, 90) + "%";
      }
    }, 250);
  }

  function finishProgress() {
    clearInterval(progressInterval);
    btnProg.style.width = "100%";
  }

  function resetProgress() {
    clearInterval(progressInterval);
    btnProg.style.width = "0%";
  }


  async function addTimelineComment(entityType, entityId, comment) {
  const url = restBase + "crm.timeline.comment.add.json";
  const p = new URLSearchParams();

  p.set("fields[ENTITY_TYPE]", entityType); // "deal" o "lead"
  p.set("fields[ENTITY_ID]", entityId);
  p.set("fields[COMMENT]", comment);

  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: p.toString()
  });

  const j = await r.json();
  if (j.error) throw new Error(j.error_description || j.error);

  return j.result;
}


  async function getContactIdByEmail(email) {
    const url = restBase + "crm.contact.list.json";
    const q = new URLSearchParams();

    q.set("filter[EMAIL]", email);
    q.set("select[]", "ID");
    q.set("select[]", "EMAIL");

    const r = await fetch(url + "?" + q.toString());
    const j = await r.json();
    if (j.error) throw new Error(j.error_description || j.error);

    // Recorre resultados y valida email EXACTO
    const list = Array.isArray(j.result) ? j.result : [];
    const target = email.toLowerCase();

    for (const c of list) {
      const emails = (c.EMAIL || []).map(e => (e.VALUE || "").toLowerCase());
      if (emails.includes(target)) return c.ID;
    }

    return null;
  }
  
// ====== BITRIX: crear PROSPECTO (LEAD) si no existe contacto ======
async function createLeadFromFormulario(email, datos = {}) {
  const url = restBase + "crm.lead.add.json";
  const p = new URLSearchParams();

  // T√≠tulo del prospecto
  p.set("fields[TITLE]", `PROSPECTO Transferencia ¬∑ ${datos.matricula || "Sin matr√≠cula"}`);
// ‚úÖ Etapa inicial del lead
p.set("fields[STATUS_ID]", "UC_CAZ7EA");

  // Email est√°ndar Bitrix
  p.set("fields[EMAIL][0][VALUE]", email);
  p.set("fields[EMAIL][0][VALUE_TYPE]", "WORK");

  // Fuente (opcional)
  p.set("fields[SOURCE_ID]", "28");

  // ============================
  // CAMPOS PERSONALIZADOS (LEAD)
  // ============================

  // Matr√≠cula
  p.set("fields[UF_CRM_60D2FEC34DE56]", datos.matricula || "");

  // Marca
  p.set("fields[UF_CRM_1636911376]", datos.marca || "");

  // Fecha primera matriculaci√≥n (ISO YYYY-MM-DD)
  p.set("fields[UF_CRM_1700163189]", datos.fechaISO || "");

  // Combustible
  p.set("fields[UF_CRM_1770134250]", datos.combustible || "");

  // Modelo
  p.set("fields[UF_CRM_1636911389]", datos.modelo || "");

  // Precio
  p.set("fields[UF_CRM_1705487083]", datos.precioNormalizado || "");

// Tipo gesti√≥n (FIJO)
p.set("fields[UF_CRM_1636368424]", "23920");

// Casos concretos (FIJO)
p.set("fields[UF_CRM_65566F70C9192]", "39294");

// Campo fijo 1
p.set("fields[UF_CRM_1611165066]", "2610");

// Campo fijo 2
p.set("fields[UF_CRM_1700170058]", "39322");

  // Sexo comprador
  p.set("fields[UF_CRM_1700160906]", datos.sexoBitrix || "");

  // Sexo vendedor
  p.set("fields[UF_CRM_1700160984]", datos.sexoVendedorBitrix || "");

  // Aut√≥nomo vendedor (1/0)
  p.set("fields[UF_CRM_1700161077]", datos.autonomoVendedorBitrix || "0");

  // Provincia comprador
  p.set("fields[UF_CRM_1700161619]", datos.provinciaCompradorBitrix || "");
  
    // Potencia (kW)
  p.set("fields[UF_CRM_65566F710AA28]", datos.kwTxt || "");

  // Potencia fiscal (CVF)
  p.set("fields[UF_CRM_65566F710015B]", datos.cvfTxt || "");

  // Cilindrada (cc)
  p.set("fields[UF_CRM_65566F70E8A83]", datos.ccTxt || "");

// ============================
// Comentarios (backup √∫til)
// ============================
const comentario = [
  "=== FORMULARIO TRANSFERENCIA VEH√çCULO (PROSPECTO) ===",
  "",
  "‚Äî CONTACTO ‚Äî",
  `Email: ${email || "‚Äî"}`,
  "",
  "‚Äî VEH√çCULO ‚Äî",
  `Matr√≠cula: ${datos.matricula || "‚Äî"}`,
  `Marca: ${datos.marca || "‚Äî"}`,
  `Modelo: ${datos.modelo || "‚Äî"}`,
  `Combustible: ${datos.combustible || "‚Äî"}`,
  `Fecha 1¬™ matriculaci√≥n (ISO): ${datos.fechaISO || "‚Äî"}`,
  "",
  "‚Äî DATOS T√âCNICOS ‚Äî",
  `P.2 (kW): ${datos.kwTxt || "‚Äî"}`,
  `P.2.1 (CVF): ${datos.cvfTxt || "‚Äî"}`,
  `P.1 (cc): ${datos.ccTxt || "‚Äî"}`,
  "",
  "‚Äî OPERACI√ìN ‚Äî",
  `Provincia comprador (texto): ${datos.provinciaCompradorTxt || "‚Äî"}`,
  `Precio indicado (texto): ${datos.precioTxt || "‚Äî"}`,
  `Precio normalizado: ${datos.precioNormalizado || "‚Äî"}`,
  "",
  "‚Äî PERSONAS ‚Äî",
  `Sexo comprador: ${document.getElementById("sexo")?.value || "‚Äî"}`,
  `Sexo vendedor: ${document.getElementById("sexoVendedor")?.value || "‚Äî"}`,
  `Vendedor aut√≥nomo (1/0): ${datos.autonomoVendedorBitrix || "0"}`,
  "",
  "‚Äî BITRIX (LEAD) ‚Äî",
  "Tipo gesti√≥n ID (FIJO): 23920",
  "Casos concretos ID (FIJO): 39294",
  "UF_CRM_1611165066 (FIJO): 2610",
  "UF_CRM_1700170058 (FIJO): 39322",
  "",
  `Provincia comprador (ID): ${datos.provinciaCompradorBitrix || "‚Äî"}`
].join("\n");

p.set("fields[COMMENTS]", comentario);

  const r = await fetch(url, {
  method: "POST",
  headers: { "Content-Type": "application/x-www-form-urlencoded" },
  body: p.toString()
});
  const j = await r.json();
console.log("crm.lead.add:", j);
if (j.error) throw new Error(j.error_description || j.error);

const leadId = j.result;

// ‚úÖ FORZAR ETAPA s√≠ o s√≠ (aunque el add la ignore)
await forceLeadStage(leadId, "UC_CAZ7EA");

return leadId;
}
// ====== BITRIX: leer email actual del LEAD ======
async function getLeadEmail(leadId){
  const url = restBase + "crm.lead.get.json?id=" + encodeURIComponent(leadId);
  const r = await fetch(url);
  const j = await r.json();
  if (j.error) throw new Error(j.error_description || j.error);

  const emails = j.result?.EMAIL || [];
  const first = emails[0]?.VALUE || "";
  return String(first).trim().toLowerCase();
}

// ====== BITRIX: actualizar PROSPECTO (LEAD) existente ======
async function updateLeadFromFormulario(leadId, email, datos = {}, opts = {}) {
  const url = restBase + "crm.lead.update.json";
  const p = new URLSearchParams();

  p.set("id", leadId);

  // T√≠tulo (opcional)
  p.set("fields[TITLE]", `PROSPECTO Transferencia ¬∑ ${datos.matricula || "Sin matr√≠cula"}`);
// ‚úÖ Mover lead a la etapa deseada
p.set("fields[STATUS_ID]", "UC_CAZ7EA");

  // Email (solo si hace falta)
if (opts.setEmail) {
  p.set("fields[EMAIL][0][VALUE]", email);
  p.set("fields[EMAIL][0][VALUE_TYPE]", "WORK");
}

  // Campos principales
  p.set("fields[UF_CRM_60D2FEC34DE56]", datos.matricula || "");
  p.set("fields[UF_CRM_1636911376]", datos.marca || "");
  p.set("fields[UF_CRM_1700163189]", datos.fechaISO || "");
  p.set("fields[UF_CRM_1770134250]", datos.combustible || "");
  p.set("fields[UF_CRM_1636911389]", datos.modelo || "");
  p.set("fields[UF_CRM_1705487083]", datos.precioNormalizado || "");

  // Fijos
  p.set("fields[UF_CRM_1636368424]", "23920");
  p.set("fields[UF_CRM_65566F70C9192]", "39294");
  p.set("fields[UF_CRM_1611165066]", "2610");
  p.set("fields[UF_CRM_1700170058]", "39322");

  // IDs (sexo, provincia, etc.)
  p.set("fields[UF_CRM_1700160906]", datos.sexoBitrix || "");
  p.set("fields[UF_CRM_1700160984]", datos.sexoVendedorBitrix || "");
  p.set("fields[UF_CRM_1700161077]", datos.autonomoVendedorBitrix || "0");
  p.set("fields[UF_CRM_1700161619]", datos.provinciaCompradorBitrix || "");

  // t√©cnicos
  p.set("fields[UF_CRM_65566F710AA28]", datos.kwTxt || "");
  p.set("fields[UF_CRM_65566F710015B]", datos.cvfTxt || "");
  p.set("fields[UF_CRM_65566F70E8A83]", datos.ccTxt || "");

  // Comentario (puedes reutilizar el mismo que ya construyes en createLead)
  if (datos.comentario) {
  p.set("fields[COMMENTS]", datos.comentario);
}

  const r = await fetch(url, {
  method: "POST",
  headers: { "Content-Type": "application/x-www-form-urlencoded" },
  body: p.toString()
});
  const j = await r.json();
  if (j.error) throw new Error(j.error_description || j.error);

  return true;
}


// ====== HELPERS: marcar required/errores ======
function setFieldError(el, on) {
  if (!el) return;
  el.style.border = on ? "2px solid crimson" : "1px solid #d0d0d0";
}

function focusAndError(el) {
  setFieldError(el, true);
  try { el.focus(); } catch(e) {}
}

  // ====== Enviar (buscar contacto por email y asociar) ======
  btnEnviar.onclick = async () => {
      // ====== CAPTURAR BLOQUE ITP (lo que ves en pantalla) ======
const itpValoracion = txt("itp_valoracion_inicial"); // Valoraci√≥n inicial
const itpFactor     = txt("itp_factor");             // Factor correcci√≥n
const itpBase       = txt("itp_base");               // Base imponible
const itpTipo       = txt("itp_tipo");               // Tipo (% / cuota fija / no aplica)
const itpCuota      = txt("itp_cuota");              // ITP (cuota)
const itpTotal      = txt("itp_total");              // Total (si lo muestras)

      const sexoCompradorTxtHuman = document.getElementById("sexo")?.value || "";
const sexoVendedorTxtHuman  = document.getElementById("sexoVendedor")?.value || "";
const esAutonomoVendedorHuman = !!document.getElementById("autonomoVendedor")?.checked;
    const esManual = modoManualActivo();

    const email = (emailContacto?.value || "").trim();

    if (!email) {
      msg.textContent = "‚ùó Indica un email de contacto";
      msg.style.color = "crimson";
      emailContacto.focus();
      return;
    }

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      msg.textContent = "‚ùó Email no v√°lido";
      msg.style.color = "crimson";
      emailContacto.focus();
      return;
    }
// ====== REQUIRED: limpiar errores previos ======
setFieldError(emailContacto, false);
setFieldError(matriculaVehiculo, false);
setFieldError(marcaSel, false);
setFieldError(fechaInput, false);
setFieldError(combSel, false);
setFieldError(modeloInput, false);
setFieldError(document.getElementById("sexo"), false);
setFieldError(document.getElementById("sexoVendedor"), false);

// ====== 2) Matr√≠cula ======
const matricula = (matriculaVehiculo?.value || "")
  .trim()
  .toUpperCase()
  .replace(/\s+/g, "");

if (!matricula) {
  msg.textContent = "‚ùó Matr√≠cula obligatoria";
  msg.style.color = "crimson";
  focusAndError(matriculaVehiculo);
  return;
}

// ====== 3) Marca ======
if (!marcaSel.value) {
  msg.textContent = "‚ùó Selecciona marca";
  msg.style.color = "crimson";
  focusAndError(marcaSel);
  return;
}

// ====== 4) Fecha primera matriculaci√≥n ======
if (!fechaISO) {
  msg.textContent = "‚ùó Selecciona fecha de primera matriculaci√≥n";
  msg.style.color = "crimson";
  focusAndError(fechaInput);
  return;
}

// ====== 5) Combustible ======
if (!combSel.value) {
  msg.textContent = "‚ùó Selecciona combustible";
  msg.style.color = "crimson";
  focusAndError(combSel);
  return;
}



const modeloTxt = esManual
  ? (modeloManualEl?.value || "").trim()
  : (modeloSeleccionado?.nombre || "").trim();

if (!modeloTxt) {
  msg.textContent = esManual ? "‚ùó Indica Modelo (D.3)" : "‚ùó Selecciona modelo";
  msg.style.color = "crimson";
  focusAndError(esManual ? modeloManualEl : modeloInput);
  return;
}

let ccTxt = "", cvfTxt = "", kwTxt = "";

if (esManual) {
  ccTxt  = (ccManualEl?.value || "").trim();
  cvfTxt = (cvfManualEl?.value || "").trim();
  kwTxt  = (kwManualEl?.value || "").trim();

  if (!ccTxt || !cvfTxt || !kwTxt) {
    msg.textContent = "‚ùó Rellena P.1 (Cilindrada), P.2.1 (Potencia fiscal) y P.2 (kW)";
    msg.style.color = "crimson";
    focusAndError(!ccTxt ? ccManualEl : !cvfTxt ? cvfManualEl : kwManualEl);
    return;
  }
}
    btnEnviar.disabled = true;
    btnText.textContent = "Enviando‚Ä¶";
    btnEnviar.style.cursor = "not-allowed";
    msg.textContent = "Buscando contacto en Bitrix‚Ä¶";
    msg.style.color = "#061a4a";

    startProgress();
// ====== Validar + convertir tipo de gesti√≥n ======
const tipoGestionTxt = (document.getElementById("tipoGestion")?.value || "").trim();

if (!tipoGestionTxt) {
  msg.textContent = "‚ùó Selecciona el tipo de gesti√≥n";
  msg.style.color = "crimson";
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}

const tipoGestionBitrix = MAP_TIPO_GESTION_BITRIX[tipoGestionTxt];

if (!tipoGestionBitrix) {
  msg.textContent = "‚ùå Tipo de gesti√≥n no reconocido";
  msg.style.color = "crimson";
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}

// ====== Validar + convertir casos concretos ======
const casosTxt = (document.getElementById("casosConcretos")?.value || "").trim();

if (!casosTxt) {
  msg.textContent = "‚ùó Selecciona casos concretos";
  msg.style.color = "crimson";
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}



const casosBitrix = MAP_CASOS_CONCRETOS_BITRIX[casosTxt];

if (!casosBitrix) {
  msg.textContent = "‚ùå Casos concretos no reconocido";
  msg.style.color = "crimson";
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}

// ====== Validar + convertir sexo ======
const sexoTxt = (document.getElementById("sexo")?.value || "").trim();

if (!sexoTxt) {
  msg.textContent = "‚ùó Selecciona sexo";
  msg.style.color = "crimson";
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}

// ====== SEXO (DEAL y LEAD) ======
const sexoDealBitrix = MAP_SEXO_BITRIX[sexoTxt];
const sexoLeadBitrix = MAP_SEXO_LEAD_BITRIX[sexoTxt];

if (!sexoDealBitrix || !sexoLeadBitrix) {
  msg.textContent = "‚ùå Sexo no reconocido";
  msg.style.color = "crimson";
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}
// ====== Validar + leer sexo vendedor ======
const sexoVendedorTxt = (document.getElementById("sexoVendedor")?.value || "").trim();

if (!sexoVendedorTxt) {
  msg.textContent = "‚ùó Selecciona sexo del vendedor";
  msg.style.color = "crimson";
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}

// ====== Validar + leer provincia comprador ======
const provinciaCompradorTxt = (document.getElementById("provinciaComprador")?.value || "").trim();

if (!provinciaCompradorTxt) {
  msg.textContent = "‚ùó Selecciona la provincia del comprador";
  msg.style.color = "crimson";
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}

// ====== SEXO VENDEDOR (DEAL y LEAD) ======
const sexoVendedorDealBitrix = MAP_SEXO_VENDEDOR_BITRIX[sexoVendedorTxt];
const sexoVendedorLeadBitrix = MAP_SEXO_VENDEDOR_LEAD_BITRIX[sexoVendedorTxt];

if (!sexoVendedorDealBitrix || !sexoVendedorLeadBitrix) {
  msg.textContent = "‚ùå Sexo vendedor no reconocido";
  msg.style.color = "crimson";
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}
// ====== PROVINCIA (DEAL y LEAD) ======
const provKey = normTxt(provinciaCompradorTxt);
const provinciaDealBitrix = MAP_PROVINCIA_COMPRADOR_BITRIX[provKey];
const provinciaLeadBitrix = MAP_PROVINCIA_LEAD_BITRIX[provKey];

if (!provinciaDealBitrix || !provinciaLeadBitrix) {
  msg.textContent = "‚ùå Provincia comprador no reconocida";
  msg.style.color = "crimson";
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}

// ‚úÖ IDs finales (Lead vs Deal)
const sexoBitrix = sexoLeadBitrix;
const sexoVendedorBitrix = sexoVendedorLeadBitrix;
const provinciaCompradorBitrix = provinciaLeadBitrix;

const sexoDealFinal = sexoDealBitrix;
const sexoVendedorDealFinal = sexoVendedorDealBitrix;
const provinciaDealFinal = provinciaDealBitrix;



// ====== ¬øEs aut√≥nomo? vendedor ======
const autonomoVendedorBitrix =
  document.getElementById("autonomoVendedor")?.checked ? "1" : "0";


// ====== Precio: leer y normalizar ======
const precioTxt = (document.getElementById("precioContrato")?.value || "").trim();

if (!precioTxt) {
  msg.textContent = "‚ùó Indica el precio";
  msg.style.color = "crimson";
  focusAndError(document.getElementById("precioContrato"));
  resetProgress();
  btnEnviar.disabled = false;
  btnText.textContent = "Enviar selecci√≥n";
  btnEnviar.style.cursor = "pointer";
  return;
}

// Normalizar precio (quita ‚Ç¨, puntos, etc.)
const precioNormalizado = precioTxt
  .replace(/[^\d,\.]/g, "")
  .replace(/\./g, "")
  .replace(",", ".");

// ‚úÖ PASO 1: preparar t√©cnicos (manual o cat√°logo) ANTES del try
let kwTxtFinal = "", cvfTxtFinal = "", ccTxtFinal = "";

if (esManual) {
  kwTxtFinal  = String(kwTxt || "").replace(/[^\d]/g, "");
  cvfTxtFinal = String(cvfTxt || "").trim();
  cvfTxtFinal = cvfTxtFinal.replace(",", "."); 
  ccTxtFinal  = String(ccTxt || "").replace(/\D/g, "");
} else {
  kwTxtFinal  = String(getKW(modeloSeleccionado) || "").replace(/[^\d]/g, "");
  cvfTxtFinal = String(getCVF(modeloSeleccionado) || "").trim();
  cvfTxtFinal = cvfTxtFinal.replace(",", ".");
  ccTxtFinal  = String(getCC(modeloSeleccionado) || "").replace(/\D/g, "");
}
// ====== CAPTURAR FICHA T√âCNICA (lo visible en pantalla) ======
const ftKwTxt      = txt("ft_kw");       // Potencia kW
const ftCvTxt      = txt("ft_cv");       // Potencia CV
const ftCvfTxt     = txt("ft_cvf");      // Potencia fiscal
const ftCcTxt      = txt("ft_cc");       // Cilindrada
const ftCilTxt     = txt("ft_cil");      // Cilindros
const ftPeriodoTxt = txt("ft_periodo");  // Periodo comercial
const ftUsoTxt     = txt("ft_uso_pct");  // A√±os uso / %
// ‚úÖ COMENTARIO TIMELINE (para burbuja en Actividades)
const comentarioTimeline = [
  "üìÑ FORMULARIO TRANSFERENCIA VEH√çCULO",
  "",
  `Email: ${email || "‚Äî"}`,
  `Matr√≠cula: ${matricula || "‚Äî"}`,
  `Marca: ${marcaSel.value || "‚Äî"}`,
  `Modelo: ${modeloTxt || "‚Äî"}`,
  `Combustible: ${labelCombustible(combSel.value) || "‚Äî"}`,
  `Fecha 1¬™ matriculaci√≥n: ${fechaISO || "‚Äî"}`,
  "",
  "‚Äî DATOS T√âCNICOS AMPLIADOS ‚Äî",
`Potencia (kW): ${ftKwTxt}`,
`Potencia (CV): ${ftCvTxt}`,
`Potencia fiscal (CVF): ${ftCvfTxt}`,
`Cilindrada (cc): ${ftCcTxt}`,
`Cilindros: ${ftCilTxt}`,
`Periodo comercial: ${ftPeriodoTxt}`,
`A√±os de uso / % aplicado: ${ftUsoTxt}`,
"",
  "",
  "‚Äî PERSONAS ‚Äî",
  `Sexo comprador: ${labelSexo(sexoCompradorTxtHuman)}`,
  `Sexo vendedor: ${labelSexo(sexoVendedorTxtHuman)}`,
  `Vendedor aut√≥nomo: ${labelSiNo(esAutonomoVendedorHuman)}`,
  "",
  `Provincia comprador: ${provinciaCompradorTxt || "‚Äî"}`,
  `Precio: ${precioTxt || "‚Äî"} (norm: ${precioNormalizado || "‚Äî"})`,
  "",
  
  // üî•üî•üî• A PARTIR DE AQU√ç ES LO NUEVO üî•üî•üî•
  "",
  "‚Äî PRESUPUESTO / ITP ‚Äî",
  `Valoraci√≥n inicial: ${itpValoracion}`,
  `Factor correcci√≥n: ${itpFactor}`,
  `Base imponible: ${itpBase}`,
  `Tipo impuesto: ${itpTipo}`,
  `ITP (cuota): ${itpCuota}`,
  "",
  "‚Äî GASTOS ‚Äî",
  `Tasa Tr√°fico: ${GASTOS_FIJOS.tasaTrafico.toFixed(2)} ‚Ç¨`,
  `Colegio Gestores: ${GASTOS_FIJOS.tasaExtra.toFixed(2)} ‚Ç¨`,
  `Gesti√≥n Hervas: ${GASTOS_FIJOS.gestionHervas.toFixed(2)} ‚Ç¨`,
`IVA 21% (Gesti√≥n Hervas): ${getIvaEG().toFixed(2)} ‚Ç¨`,
  `TOTAL: ${itpTotal}`
].join("\n");

try {

  // ==========================================
  // ‚úÖ MODO EDICI√ìN: si viene ?Id=123 => UPDATE LEAD
  // ==========================================
  if (LEAD_ID_EN_URL) {
    msg.textContent = `Actualizando prospecto ${LEAD_ID_EN_URL} en Bitrix‚Ä¶`;
    msg.style.color = "#061a4a";
// ‚úÖ comparar email actual del lead vs email del formulario
const emailNuevo = (email || "").trim().toLowerCase();
const emailActual = await getLeadEmail(LEAD_ID_EN_URL);
const mandarEmailEnUpdate = (emailNuevo && emailNuevo !== emailActual);

    const comentario = [
      "=== FORMULARIO TRANSFERENCIA VEH√çCULO (ACTUALIZACI√ìN) ===",
      "",
      "‚Äî CONTACTO ‚Äî",
      `Email: ${email || "‚Äî"}`,
      "",
      "‚Äî VEH√çCULO ‚Äî",
      `Matr√≠cula: ${matricula || "‚Äî"}`,
      `Marca: ${marcaSel.value || "‚Äî"}`,
      `Modelo: ${modeloTxt || "‚Äî"}`,
      `Combustible: ${labelCombustible(combSel.value) || "‚Äî"}`,
      `Fecha 1¬™ matriculaci√≥n (ISO): ${fechaISO || "‚Äî"}`,
      "",
      "‚Äî DATOS T√âCNICOS ‚Äî",
      `P.2 (kW): ${kwTxtFinal || "‚Äî"}`,
      `P.2.1 (CVF): ${cvfTxtFinal || "‚Äî"}`,
      `P.1 (cc): ${ccTxtFinal || "‚Äî"}`,
      "",
      "‚Äî OPERACI√ìN ‚Äî",
      `Provincia comprador (texto): ${provinciaCompradorTxt || "‚Äî"}`,
      `Precio normalizado: ${precioNormalizado || "‚Äî"}`
    ].join("\n");

    await updateLeadFromFormulario(LEAD_ID_EN_URL, email, {
      matricula,
      marca: marcaSel.value,
      fechaISO,
      combustible: labelCombustible(combSel.value),
      modelo: modeloTxt,
      precioNormalizado,

      tipoGestionBitrix,
      casosBitrix,

      sexoBitrix,
      sexoVendedorBitrix,
      autonomoVendedorBitrix,
      provinciaCompradorBitrix,
      provinciaCompradorTxt,

      kwTxt: kwTxtFinal,
      cvfTxt: cvfTxtFinal,
      ccTxt: ccTxtFinal,

      comentario
    }, { setEmail: mandarEmailEnUpdate });
await addTimelineComment("lead", LEAD_ID_EN_URL, comentarioTimeline);
    finishProgress();
    btnText.textContent = "Actualizado ‚úî";
    msg.textContent = `‚úÖ Prospecto actualizado (Lead ${LEAD_ID_EN_URL}).`;
    msg.style.color = "green";
    return;
  }

  // ==========================================
  // ‚úÖ FLUJO NORMAL (lo que ya ten√≠as)
  // ==========================================
  const contactId = await getContactIdByEmail(email);

  if (!contactId) {
    msg.textContent = "No existe contacto. Creando prospecto en Bitrix‚Ä¶";
    msg.style.color = "#061a4a";

    const leadId = await createLeadFromFormulario(email, {
      matricula,
      marca: marcaSel.value,
      fechaISO,
      combustible: labelCombustible(combSel.value),
      modelo: modeloTxt,

      precioTxt,
      precioNormalizado,

      tipoGestionBitrix,
      casosBitrix,
      sexoBitrix,
      sexoVendedorBitrix,
      autonomoVendedorBitrix,
      provinciaCompradorBitrix,
      provinciaCompradorTxt,

      kwTxt: kwTxtFinal,
      cvfTxt: cvfTxtFinal,
      ccTxt: ccTxtFinal,
    });
await addTimelineComment("lead", leadId, comentarioTimeline);

    finishProgress();
    btnText.textContent = "Enviado ‚úî";
    msg.textContent = `‚úÖ Prospecto creado (Lead ${leadId}). Nuestro equipo continuar√° el tr√°mite.`;
    msg.style.color = "green";
    return;
  }

  msg.textContent = "Creando negociaci√≥n en Bitrix‚Ä¶";
      msg.style.color = "#061a4a";

      const base = restBase + "crm.deal.add.json";
      const p = new URLSearchParams();

      p.set("fields[TITLE]", `${matricula} - VEH. Presupuesto Veh√≠culos Transferencia Colab`);

      // ‚úÖ asociaci√≥n real del contacto
      p.set("fields[CONTACT_ID]", contactId);
p.set("fields[SOURCE_ID]", "28");
p.set("fields[STAGE_ID]", "C10:UC_60TUD1");
p.set("fields[CATEGORY_ID]", "10");
p.set("fields[UF_CRM_5FFC3E49E703A]", "918");

      p.set("fields[UF_CRM_1613497017]", marcaSel.value);
      p.set("fields[UF_CRM_1610644803]", tipoGestionBitrix);
      p.set("fields[UF_CRM_1646758928]", casosBitrix);
      p.set("fields[UF_CRM_1614621036]", sexoDealFinal);
      p.set("fields[UF_CRM_1614621146]", sexoVendedorDealFinal);
      p.set("fields[UF_CRM_1615570102]", autonomoVendedorBitrix);
      p.set("fields[UF_CRM_1613474689]", provinciaDealFinal);
      p.set("fields[UF_CRM_1704963093]", precioNormalizado);
p.set("fields[UF_CRM_1720110326]", "48572");
p.set("fields[UF_CRM_1613473375]", cvfTxtFinal); // P.2.1
p.set("fields[UF_CRM_1613471054]", ccTxtFinal);  // P.1
p.set("fields[UF_CRM_1613473435]", kwTxtFinal);  // P.2


      p.set("fields[UF_CRM_1610623540]", modeloTxt); // D.3
      p.set("fields[UF_CRM_1636368189]", labelCombustible(combSel.value));
      p.set("fields[UF_CRM_1610622809]", matricula);

      // Valoraci√≥n ajustada
      if (!esManual) {
  p.set("fields[UF_CRM_1700568311]", getValorAjustadoRaw(modeloSeleccionado));
}

            if (!esManual) {
  p.set("fields[UF_CRM_1621337594]", getPeriodo(modeloSeleccionado));
}

      const r = await fetch(base, {
  method: "POST",
  headers: { "Content-Type": "application/x-www-form-urlencoded" },
  body: p.toString()
});

      const j = await r.json();
      if (j.error) throw new Error(j.error_description || j.error);
await addTimelineComment("deal", j.result, comentarioTimeline);
      finishProgress();
      btnText.textContent = "Enviado ‚úî";
      msg.textContent = `‚úÖ Enviado (Deal ${j.result}) ¬∑ Contacto ${contactId}`;
      msg.style.color = "green";
    } catch (e) {
      console.error(e);
      resetProgress();
      btnEnviar.disabled = false;
      btnText.textContent = "Reintentar env√≠o";
      msg.textContent = "‚ùå Error al enviar";
      msg.style.color = "crimson";
      btnEnviar.style.cursor = "pointer";
    }
  };
// ====== REGLAS VISUALES (COMBINADAS) ======
const sexoVendedorSel = document.getElementById("sexoVendedor");
const chkAutonomoVendedor = document.getElementById("autonomoVendedor");

const wrapProvinciaComprador = document.getElementById("wrapProvinciaComprador");
const wrapAutonomoVendedor   = document.getElementById("wrapAutonomoVendedor");

function aplicarReglas() {
  const sexo = (sexoVendedorSel?.value || "").trim();
  const esSociedad = (sexo === "SOCIEDAD");

  // ‚úÖ NUNCA ocultar provincia comprador
  wrapProvinciaComprador.style.display = "block";

  // ‚úÖ Si quieres mantener que el checkbox "aut√≥nomo" se oculte cuando es SOCIEDAD (esto s√≠ puede quedarse)
  wrapAutonomoVendedor.style.display = esSociedad ? "none" : "block";

  // ‚úÖ Si es SOCIEDAD, desmarco aut√≥nomo (opcional, pero coherente)
  if (esSociedad) {
    chkAutonomoVendedor.checked = false;
  }

  // üö´ Importante: NO borrar nunca la provincia del comprador
  // document.getElementById("provinciaComprador").value = "";  // <- fuera
}


// Eventos
sexoVendedorSel?.addEventListener("change", aplicarReglas);
chkAutonomoVendedor?.addEventListener("change", aplicarReglas);

// Ejecutar al cargar
aplicarReglas();

// ============================
// EVENTOS PARA REFRESCAR EL BOT√ìN
// ============================
[
  emailContacto,
  matriculaVehiculo,
  marcaSel,
  fechaInput,
  combSel,
  modeloInput,
  document.getElementById("modeloNoLista"),
document.getElementById("modeloManual"),
document.getElementById("ccManual"),
document.getElementById("cvfManual"),
document.getElementById("kwManual"),
  document.getElementById("sexo"),
  document.getElementById("sexoVendedor"),
  document.getElementById("provinciaComprador"),
  document.getElementById("precioContrato"),
  document.getElementById("autonomoVendedor"),
].forEach(el => {
  if (!el) return;
  el.addEventListener("input", refrescarBotonEnviar);
  el.addEventListener("change", refrescarBotonEnviar);
});

// Estado inicial (apagado al cargar)
refrescarBotonEnviar();
// watcher antifallos autofill (NO falla nunca)
setInterval(refrescarBotonEnviar, 1000);
  // ARRANQUE
  cargarCatalogo().catch(err => {
    console.error("Error cargando cat√°logo:", err);
    if (msg) {
      msg.textContent = "‚ùå Error cargando cat√°logo de veh√≠culos";
      msg.style.color = "crimson";
    }
  });
// ‚úÖ Estado inicial al final (cuando YA existe todo)
function cerrarDropdownModelo() {
  if (modeloList) modeloList.style.display = "none";
  if (modeloPrev) modeloPrev.style.display = "none";
}

function clickDentroModelo(target) {
  return (
    modeloInput?.contains(target) ||
    modeloList?.contains(target) ||
    modeloPrev?.contains(target)
  );
}

// Click fuera => cerrar
document.addEventListener("mousedown", (e) => {
  if (!clickDentroModelo(e.target)) cerrarDropdownModelo();
});

// ESC => cerrar
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") cerrarDropdownModelo();
});


toggleModeloManual();
actualizarPresupuestoITP();
actualizarNecesariosPresupuesto();
refrescarBotonEnviar();
async function debugLeadStatuses(){
  const url = restBase + "crm.status.list.json?filter[ENTITY_ID]=STATUS";
  const r = await fetch(url);
  const j = await r.json();
  console.log("LEAD STATUSES:", j.result?.map(x => ({ID:x.STATUS_ID, NAME:x.NAME})));
}
debugLeadStatuses();
</script>
  </body>
</html>